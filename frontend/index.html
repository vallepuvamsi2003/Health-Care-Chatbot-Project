<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthBot AI - Premium Healthcare Assistant</title>
    
    <link rel="icon" type="image/png" href="C:\Users\valle\Documents\MINI Project\medical-robot (1).png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Base font - Using Plus Jakarta Sans for a more modern tech/medical feel */
        body {
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* Custom scrollbar */
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Style for textarea auto-resizing */
        .textarea-auto-resize { overflow: hidden; resize: none; }

        /* --- Animations --- */
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInSlideUp { animation: fadeInSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-15px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slideInLeft { animation: slideInLeft 0.4s ease-out forwards; }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(15px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slideInRight { animation: slideInRight 0.4s ease-out forwards; }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(-10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-popIn { animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .dot-animation span { animation: bounce 0.8s infinite ease-in-out; }
        .dot-animation span:nth-child(2) { animation-delay: 0.15s; }
        .dot-animation span:nth-child(3) { animation-delay: 0.3s; }

        /* Subtle Medical Background Pattern */
        .medical-pattern {
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .hero-glow::before {
            content: ''; position: absolute; top: -20%; left: 50%;
            width: 140%; height: 140%;
            background: radial-gradient(circle at center, rgba(59, 130, 246, 0.08) 0%, rgba(99, 102, 241, 0.05) 30%, transparent 70%);
            animation: pulseGlow 8s infinite ease-in-out;
            z-index: 0; pointer-events: none; transform: translate(-50%, 0);
        }
        @keyframes pulseGlow {
            0% { opacity: 0.6; transform: translate(-50%, 0) scale(0.95); }
            50% { opacity: 1; transform: translate(-50%, 0) scale(1.05); }
            100% { opacity: 0.6; transform: translate(-50%, 0) scale(0.95); }
        }

        @keyframes micPulse {
            0% { box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.4); }
            100% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
        }
        .mic-recording-pulse { animation: micPulse 1.5s infinite; }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }

        .chat-bubble-shadow {
            box-shadow: 0 2px 5px -1px rgba(0, 0, 0, 0.05), 0 1px 3px -1px rgba(0, 0, 0, 0.03);
        }

        /* Accessibility: Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .animate-fadeInSlideUp, .animate-slideInLeft, .animate-slideInRight,
            .animate-popIn, .dot-animation span, .hero-glow::before,
            .mic-recording-pulse, .transition-all,
            .transition, .transition-colors, .transition-transform {
                animation: none !important;
                transition: none !important;
            }
        }
    </style>
    <script>
        // Custom Tailwind CSS Configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: {
                        // REPLACED: New Professional "Royal Blue" Palette
                        'primary': {
                            50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe',
                            300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6',
                            600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af',
                            900: '#1e3a8a', 950: '#172554',
                        },
                        // Soft Indigo accents for depth
                        'accent': {
                            50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5',
                        },
                        'secondary': { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 800: '#1e293b' },
                        'warning': {
                            50: '#fff7ed', 100: '#ffedd5', 600: '#ea580c', 700: '#c2410c',
                        },
                        'emergency': {
                            50: '#fef2f2', 100: '#fee2e2', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'glow': '0 0 15px rgba(59, 130, 246, 0.3)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen text-slate-800 antialiased selection:bg-primary-100 selection:text-primary-700">
    <div id="message-box-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col items-center space-y-3 pointer-events-none"></div>

    <div id="modal-container"></div>

    <div id="app" class="flex flex-col min-h-screen bg-slate-50">
        </div>

    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // Global listener to close open menus
            document.body.addEventListener('click', (e) => {
                const menuButton = e.target.closest('.conv-menu-btn');
                document.querySelectorAll('.conv-menu-dropdown').forEach(menu => {
                    if (!menuButton || !menu.contains(menuButton)) {
                        menu.classList.add('hidden');
                    }
                });
            });
        });

        const appContainer = document.getElementById('app');
        let currentView = 'landing';
        let userId = 'user-' + Math.random().toString(36).substr(2, 9);
        let allConversations = []; // Stores metadata { id, title, lastMessage, timestamp }
        let currentConversationId = null; // ID of the active chat
        let currentConversationMessages = []; // Stores messages { text, sender, timestamp, ... } for the active chat
        let isLoading = false;
        let isRecording = false;
        let uploadedFiles = [];
        let isSidebarCollapsed = false; // State for collapsible sidebar

        const BACKEND_API_URL = 'https://health-care-chatbot-project-grrd.onrender.com/';

        // Web Speech API setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onstart = () => { isRecording = true; updateMicButtonState(); };
            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                const chatInput = document.getElementById('chat-input');
                if (chatInput) { chatInput.value = speechResult; adjustTextareaHeight(); }
            };
            recognition.onend = () => { isRecording = false; updateMicButtonState(); };
            recognition.onerror = (event) => {
                isRecording = false;
                updateMicButtonState();
                displayMessageBox(`Voice input error: ${event.error}.`, 'error');
            };
        } else {
            console.warn("Web Speech API not supported in this browser.");
        }


        // --- Utility Functions ---

        function sanitizeHTML(str) {
            if (!str) return ""; // Handle null or undefined strings
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function markdownToHtml(markdownText) {
            let html = sanitizeHTML(markdownText);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');       // Italic
            html = html.replace(/```([\s\S]*?)```/g, '<pre class="bg-slate-100 p-3 rounded-lg text-sm my-2 overflow-x-auto text-slate-700 font-mono border border-slate-200"><code>$1</code></pre>'); // Code blocks
            html = html.replace(/`([^`]+)`/g, '<code class="bg-slate-100 px-1.5 py-0.5 rounded text-sm text-primary-700 font-mono border border-slate-200">$1</code>'); // Inline code
            html = html.replace(/\n/g, '<br>'); // Line breaks
            return html;
        }

        async function exponentialBackoffFetch(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return exponentialBackoffFetch(url, options, retries - 1, delay * 2);
                } else {
                    console.error("Fetch failed after multiple retries:", error);
                    throw error; // Re-throw the error after final retry
                }
            }
        }

        function displayMessageBox(message, type = 'info') {
            const container = document.getElementById('message-box-container');
            if (!container) return; // Exit if container not found
            const messageBox = document.createElement('div');
            // UPDATED STYLE
            messageBox.className = `px-4 py-3 rounded-xl shadow-soft text-sm font-medium pointer-events-auto flex items-center space-x-3 animate-popIn backdrop-blur-md border border-opacity-20`;
            
            let icon = 'info';
            if (type === 'error') { 
                messageBox.classList.add('bg-emergency-600/90', 'text-white', 'border-emergency-700'); 
                icon = 'alert-octagon'; 
            }
            else if (type === 'success') { 
                messageBox.classList.add('bg-emerald-600/90', 'text-white', 'border-emerald-700'); 
                icon = 'check-circle-2'; 
            }
            else { 
                messageBox.classList.add('bg-slate-800/90', 'text-white', 'border-slate-700'); 
            } // Default info
            
            messageBox.innerHTML = `<i data-lucide="${icon}" class="h-5 w-5 flex-shrink-0"></i> <span>${sanitizeHTML(message)}</span>`;
            container.appendChild(messageBox);
            lucide.createIcons(); // Ensure icon renders
            // Auto-remove after 3 seconds
            setTimeout(() => {
                messageBox.classList.add('opacity-0', 'translate-y-[-10px]', 'transition-all', 'duration-500');
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }

        // --- Custom Modal Functions ---
        function renderConfirmationModal(title, message, onConfirm) {
            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) return;
            const modalId = 'modal-' + Math.random().toString(36).substr(2, 9);
            
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fadeInSlideUp p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm border border-slate-100">
                    <div class="flex items-center space-x-3 mb-4 text-emergency-600">
                        <div class="bg-emergency-50 p-2 rounded-full">
                            <i data-lucide="alert-triangle" class="h-6 w-6"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800">${sanitizeHTML(title)}</h3>
                    </div>
                    <p class="text-slate-600 leading-relaxed mb-6">${sanitizeHTML(message)}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-${modalId}" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2.5 px-5 rounded-xl transition-colors">Cancel</button>
                        <button id="confirm-${modalId}" class="bg-emergency-600 hover:bg-emergency-700 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-emergency-600/20 transition-all hover:scale-[1.02]">Delete</button>
                    </div>
                </div>
            `;
            modalContainer.appendChild(modal);
            lucide.createIcons();

            const closeModal = () => modalContainer.removeChild(modal);
            document.getElementById(`cancel-${modalId}`).addEventListener('click', closeModal);
            document.getElementById(`confirm-${modalId}`).addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
        }

        function renderRenameModal(convId, currentTitle) {
            const modalContainer = document.getElementById('modal-container');
             if (!modalContainer) return;
            const modalId = 'modal-' + Math.random().toString(36).substr(2, 9);
            
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50 animate-fadeInSlideUp p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm border border-slate-100">
                    <div class="flex items-center space-x-3 mb-4 text-primary-600">
                        <div class="bg-primary-50 p-2 rounded-full">
                            <i data-lucide="edit-3" class="h-6 w-6"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-800">Rename Chat</h3>
                    </div>
                    <p class="text-slate-500 text-sm mb-2">Give this conversation a new title.</p>
                    <input id="rename-input-${modalId}" type="text" class="w-full p-3 border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition-all text-slate-800 font-medium" value="${sanitizeHTML(currentTitle)}">
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="cancel-${modalId}" class="bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-2.5 px-5 rounded-xl transition-colors">Cancel</button>
                        <button id="save-${modalId}" class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2.5 px-5 rounded-xl shadow-lg shadow-primary-600/20 transition-all hover:scale-[1.02]">Save Changes</button>
                    </div>
                </div>
            `;
            modalContainer.appendChild(modal);
            lucide.createIcons();

            const closeModal = () => modalContainer.removeChild(modal);
            document.getElementById(`cancel-${modalId}`).addEventListener('click', closeModal);
            document.getElementById(`save-${modalId}`).addEventListener('click', () => {
                const newTitleInput = document.getElementById(`rename-input-${modalId}`);
                const newTitle = newTitleInput ? newTitleInput.value.trim() : "";
                if (newTitle) {
                    const conv = allConversations.find(c => c.id === convId);
                    if (conv) {
                        conv.title = newTitle;
                        saveAllConversations();
                        renderHistoryList(); // Update the list display
                        // If renaming the active chat, update its header
                        if (convId === currentConversationId) {
                            renderActiveChat(); // Re-render the chat window to update title
                        }
                    }
                    closeModal();
                } else {
                    displayMessageBox("Please enter a valid name.", "error");
                }
            });
        }

        // --- Data Persistence (localStorage) ---
        function saveAllConversations() {
            allConversations.sort((a, b) => b.timestamp - a.timestamp); // Keep sorted by most recent
            localStorage.setItem('healthBotConversations', JSON.stringify(allConversations));
        }

        function saveCurrentConversationMessages() {
            if (currentConversationId) {
                localStorage.setItem(`healthBot_${currentConversationId}`, JSON.stringify(currentConversationMessages));
            }
        }

        function loadAllConversations() {
            allConversations = JSON.parse(localStorage.getItem('healthBotConversations')) || [];
            allConversations.sort((a, b) => b.timestamp - a.timestamp); // Ensure sorted on load
        }

        function loadConversationMessages(convId) {
            return JSON.parse(localStorage.getItem(`healthBot_${convId}`)) || [];
        }

        function deleteConversationFromStorage(convId) {
            localStorage.removeItem(`healthBot_${convId}`); // Remove messages
            allConversations = allConversations.filter(c => c.id !== convId); // Remove metadata
            saveAllConversations(); // Save updated metadata list
        }

        // --- Component Rendering Functions ---

        function renderLandingPage() {
            appContainer.innerHTML = `
                <header class="fixed top-0 left-0 right-0 z-20 glass-effect py-4 px-6 md:px-12 flex items-center justify-between transition-all duration-300 animate-fadeInSlideUp">
                    <div class="flex items-center space-x-2.5">
                        <div class="bg-gradient-to-tr from-primary-600 to-accent-500 p-2 rounded-lg shadow-lg shadow-primary-500/30">
                            <i data-lucide="activity" class="h-6 w-6 text-white"></i>
                        </div>
                        <span class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-slate-900 to-slate-700 tracking-tight">HealthBot AI</span>
                    </div>
                    <nav class="hidden md:flex items-center space-x-8">
                        <a href="#features" class="text-slate-600 hover:text-primary-600 font-medium transition-colors duration-200">Features</a>
                        <a href="#how-it-works" class="text-slate-600 hover:text-primary-600 font-medium transition-colors duration-200">How It Works</a>
                        <a href="#safety" class="text-slate-600 hover:text-primary-600 font-medium transition-colors duration-200">Safety</a>
                        <button id="start-chat-nav-btn"
                            class="bg-slate-900 hover:bg-primary-600 text-white font-semibold py-2.5 px-6 rounded-full shadow-lg shadow-slate-900/10 hover:shadow-primary-600/20 transition-all duration-300 transform hover:-translate-y-0.5">
                            Start Consultation
                        </button>
                    </nav>
                    <button class="md:hidden text-slate-600 p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <i data-lucide="menu" class="h-6 w-6"></i>
                    </button>
                </header>

                <main class="flex-grow pt-24 bg-slate-50">
                    <section class="relative bg-gradient-to-b from-white via-primary-50/50 to-white pt-16 pb-24 md:pt-24 md:pb-32 text-center overflow-hidden hero-glow">
                        <div class="relative z-10 max-w-5xl mx-auto px-6 animate-fadeInSlideUp" style="animation-delay: 0.1s;">
                            <span class="inline-flex items-center gap-2 bg-white border border-primary-100 text-primary-700 text-sm font-semibold px-4 py-1.5 rounded-full mb-6 shadow-sm hover:shadow-md transition-shadow">
                                <span class="relative flex h-2 w-2">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-2 w-2 bg-primary-500"></span>
                                </span>
                                AI-Powered Healthcare Assistant
                            </span>
                            <h1 class="text-5xl md:text-7xl font-extrabold mb-6 leading-[1.1] tracking-tight text-slate-900">
                                Your Health, <br>
                                <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary-600 to-accent-600">Intelligently</span> Simplified.
                            </h1>
                            <p class="text-lg md:text-xl mb-10 text-slate-500 max-w-2xl mx-auto leading-relaxed">
                                Experience 24/7 personalized health guidance powered by advanced AI. Instant answers, symptom analysis, and peace of mind.
                            </p>
                            
                            <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-16">
                                <button id="start-consultation-btn"
                                    class="w-full sm:w-auto bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white font-bold py-4 px-8 rounded-full shadow-xl shadow-primary-600/20 transform hover:-translate-y-1 transition-all duration-300 flex items-center justify-center gap-2">
                                    Start Free Consultation <i data-lucide="arrow-right" class="h-5 w-5"></i>
                                </button>
                                <a href="#how-it-works"
                                    class="w-full sm:w-auto bg-white border border-slate-200 hover:border-slate-300 text-slate-700 hover:text-slate-900 font-bold py-4 px-8 rounded-full shadow-sm hover:shadow-md transform hover:-translate-y-1 transition-all duration-300">
                                    Learn How It Works
                                </a>
                            </div>

                             <div class="bg-white/60 backdrop-blur-sm border border-orange-100 rounded-2xl p-4 max-w-3xl mx-auto flex items-start gap-3 text-left">
                                <i data-lucide="info" class="text-orange-500 mt-1 flex-shrink-0"></i>
                                <p class="text-sm text-slate-600">
                                    <span class="font-bold text-orange-700">Disclaimer:</span> HealthBot AI offers informational guidance only. It is not a substitute for professional medical advice, diagnosis, or treatment.
                                </p>
                            </div>
                        </div>
                    </section>

                    <section id="features" class="py-24 bg-white relative">
                        <div class="absolute inset-0 medical-pattern opacity-50 pointer-events-none"></div>
                        <div class="max-w-6xl mx-auto px-6 relative z-10">
                            <div class="text-center mb-16">
                                <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-4 tracking-tight">Advanced Capabilities</h2>
                                <p class="text-lg text-slate-500 max-w-2xl mx-auto">Merging medical knowledge with cutting-edge AI for comprehensive support.</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                <div class="bg-slate-50 p-8 rounded-3xl border border-slate-100 hover:border-primary-100 hover:bg-white hover:shadow-xl hover:shadow-primary-900/5 transition-all duration-300 group">
                                    <div class="w-14 h-14 bg-blue-100 text-primary-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i data-lucide="stethoscope" class="h-7 w-7"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-3">Symptom Analysis</h3>
                                    <p class="text-slate-600 leading-relaxed">Detailed breakdown of potential causes based on your described symptoms and history.</p>
                                </div>
                                <div class="bg-slate-50 p-8 rounded-3xl border border-slate-100 hover:border-primary-100 hover:bg-white hover:shadow-xl hover:shadow-primary-900/5 transition-all duration-300 group">
                                    <div class="w-14 h-14 bg-indigo-100 text-accent-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i data-lucide="message-square-heart" class="h-7 w-7"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-3">Medical Q&A</h3>
                                    <p class="text-slate-600 leading-relaxed">Instant, evidence-based answers to your questions about medications, conditions, and wellness.</p>
                                </div>
                                <div class="bg-slate-50 p-8 rounded-3xl border border-slate-100 hover:border-primary-100 hover:bg-white hover:shadow-xl hover:shadow-primary-900/5 transition-all duration-300 group">
                                    <div class="w-14 h-14 bg-teal-100 text-teal-600 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-300">
                                        <i data-lucide="scan-eye" class="h-7 w-7"></i>
                                    </div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-3">Visual Recognition</h3>
                                    <p class="text-slate-600 leading-relaxed">Upload images of skin issues or medications for instant AI identification and information.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section id="how-it-works" class="py-24 bg-slate-50">
                        <div class="max-w-6xl mx-auto px-6">
                             <div class="text-center mb-16">
                                <h2 class="text-3xl md:text-4xl font-extrabold text-slate-900 mb-4 tracking-tight">Simple & Secure</h2>
                                <p class="text-lg text-slate-500 max-w-2xl mx-auto">Get the guidance you need in three seamless steps.</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-12 relative">
                                <div class="hidden md:block absolute top-12 left-[16%] right-[16%] h-0.5 bg-gradient-to-r from-transparent via-slate-300 to-transparent z-0"></div>

                                <div class="relative z-10 flex flex-col items-center text-center">
                                    <div class="w-24 h-24 bg-white rounded-full border-4 border-slate-100 flex items-center justify-center shadow-lg mb-6">
                                        <span class="text-3xl font-black text-primary-600">1</span>
                                    </div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2">Input Details</h3>
                                    <p class="text-slate-600">Describe symptoms or upload photos.</p>
                                </div>
                                <div class="relative z-10 flex flex-col items-center text-center">
                                    <div class="w-24 h-24 bg-white rounded-full border-4 border-slate-100 flex items-center justify-center shadow-lg mb-6">
                                        <span class="text-3xl font-black text-primary-600">2</span>
                                    </div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2">AI Processing</h3>
                                    <p class="text-slate-600">Advanced algorithms analyze data instantly.</p>
                                </div>
                                <div class="relative z-10 flex flex-col items-center text-center">
                                    <div class="w-24 h-24 bg-white rounded-full border-4 border-slate-100 flex items-center justify-center shadow-lg mb-6">
                                        <span class="text-3xl font-black text-primary-600">3</span>
                                    </div>
                                    <h3 class="text-xl font-bold text-slate-900 mb-2">Receive Insight</h3>
                                    <p class="text-slate-600">Get clear, actionable health guidance.</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <section id="safety" class="py-24 bg-white">
                        <div class="max-w-4xl mx-auto px-6">
                            <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-[2.5rem] p-10 md:p-16 text-white shadow-2xl relative overflow-hidden">
                                <div class="absolute top-0 right-0 -mr-20 -mt-20 w-80 h-80 bg-primary-500 rounded-full blur-[100px] opacity-20"></div>
                                <div class="relative z-10 text-center">
                                    <i data-lucide="shield-check" class="h-16 w-16 text-emerald-400 mx-auto mb-6"></i>
                                    <h2 class="text-3xl md:text-4xl font-bold mb-6">Safety First Protocol</h2>
                                    <p class="text-slate-300 text-lg mb-10 leading-relaxed max-w-2xl mx-auto">
                                        We prioritize your well-being. HealthBot AI is programmed to recognize emergencies and direct you to human care immediately.
                                    </p>
                                    <div class="grid md:grid-cols-2 gap-6 text-left">
                                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                                            <h4 class="font-bold text-lg mb-2 flex items-center gap-2"><i data-lucide="check" class="h-5 w-5 text-emerald-400"></i> What We Do</h4>
                                            <ul class="space-y-2 text-slate-300 text-sm">
                                                <li>• Provide general information</li>
                                                <li>• Analyze potential symptom causes</li>
                                                <li>• Offer wellness suggestions</li>
                                            </ul>
                                        </div>
                                        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/10">
                                            <h4 class="font-bold text-lg mb-2 flex items-center gap-2"><i data-lucide="x" class="h-5 w-5 text-red-400"></i> What We Don't Do</h4>
                                            <ul class="space-y-2 text-slate-300 text-sm">
                                                <li>• Official medical diagnosis</li>
                                                <li>• Prescribe medication</li>
                                                <li>• Handle active emergencies</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="py-24 bg-slate-50">
                        <div class="max-w-4xl mx-auto px-6 text-center">
                            <h2 class="text-4xl font-bold text-slate-900 mb-6">Ready to prioritize your health?</h2>
                            <p class="text-slate-500 text-lg mb-10">Join thousands using HealthBot AI for smarter health decisions.</p>
                            <button id="start-consultation-footer-btn"
                                class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-4 px-10 rounded-full shadow-xl shadow-primary-600/30 transform hover:-translate-y-1 transition-all duration-300">
                                Start Your Free Consultation
                            </button>
                        </div>
                    </section>
                </main>

                <footer class="bg-white border-t border-slate-100 pt-16 pb-8 px-6">
                    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-12 mb-12">
                        <div class="space-y-4">
                            <div class="flex items-center space-x-2">
                                <div class="bg-primary-600 p-1.5 rounded-lg">
                                    <i data-lucide="activity" class="h-5 w-5 text-white"></i>
                                </div>
                                <span class="text-xl font-bold text-slate-900">HealthBot AI</span>
                            </div>
                            <p class="text-slate-500 text-sm leading-relaxed">Your trusted AI healthcare companion, available 24/7 to provide guidance and clarity.</p>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-900 mb-4">Product</h4>
                            <ul class="space-y-2 text-sm text-slate-500">
                                <li><a href="#" class="hover:text-primary-600 transition-colors">Features</a></li>
                                <li><a href="#" class="hover:text-primary-600 transition-colors">Technology</a></li>
                                <li><a href="#" class="hover:text-primary-600 transition-colors">Security</a></li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-900 mb-4">Resources</h4>
                            <ul class="space-y-2 text-sm text-slate-500">
                                <li><a href="#" class="hover:text-primary-600 transition-colors">Medical Disclaimer</a></li>
                                <li><a href="#" class="hover:text-primary-600 transition-colors">Privacy Policy</a></li>
                                <li><a href="#" class="hover:text-primary-600 transition-colors">Terms of Use</a></li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-900 mb-4">Contact</h4>
                            <ul class="space-y-2 text-sm text-slate-500">
                                <li>support@healthbot.ai</li>
                                <li>+1 (555) 123-4567</li>
                            </ul>
                        </div>
                    </div>
                    <div class="max-w-6xl mx-auto text-center text-sm text-slate-400 border-t border-slate-100 pt-8">
                        &copy; 2025 HealthBot AI. All rights reserved.
                    </div>
                </footer>
            `;
            lucide.createIcons();

            // Attach event listeners for landing page buttons
            document.getElementById('start-chat-nav-btn')?.addEventListener('click', startChat);
            document.getElementById('start-consultation-btn')?.addEventListener('click', startChat);
            document.getElementById('start-consultation-footer-btn')?.addEventListener('click', startChat);
        }

        // --- CHAT LAYOUT FUNCTIONS ---

        /**
         * Renders the main 2-column shell for the chat interface, handling sidebar state.
         */
        function renderChatLayout() {
            // Determine sidebar state classes based on isSidebarCollapsed
            const sidebarWidthClass = isSidebarCollapsed ? 'md:w-0' : 'md:w-80'; // Fixed width sidebar for cleaner look
            const sidebarVisibilityClass = isSidebarCollapsed ? 'md:overflow-hidden md:invisible md:opacity-0' : 'md:visible md:opacity-100';

            appContainer.innerHTML = `
                <div class="flex h-screen w-full bg-slate-50 overflow-hidden">
                    
                    <div id="chat-history-sidebar" class="w-full ${sidebarWidthClass} h-full bg-white border-r border-slate-200 flex flex-col shadow-sm z-10 transition-all duration-300 ease-in-out ${sidebarVisibilityClass} ${currentConversationId ? 'hidden md:flex' : 'flex'}">
                        <div class="p-5 border-b border-slate-100 flex items-center justify-between flex-shrink-0">
                            <div class="flex items-center space-x-2">
                                <div class="bg-primary-600 p-1.5 rounded-lg">
                                    <i data-lucide="activity" class="h-5 w-5 text-white"></i>
                                </div>
                                <span class="text-lg font-bold text-slate-800 tracking-tight">HealthBot</span>
                            </div>
                            <button id="back-to-landing-btn" class="text-slate-400 hover:text-slate-700 p-2 rounded-lg hover:bg-slate-100 transition-colors" title="Back to Home">
                                <i data-lucide="log-out" class="h-5 w-5"></i>
                            </button>
                        </div>
                        
                        <div class="p-4">
                            <button id="new-chat-btn" class="w-full bg-slate-900 hover:bg-primary-600 text-white font-semibold py-3 px-4 rounded-xl shadow-lg shadow-slate-900/10 hover:shadow-primary-600/20 transition-all duration-300 transform hover:-translate-y-0.5 flex items-center justify-center space-x-2">
                                <i data-lucide="plus" class="h-5 w-5"></i>
                                <span>New Consultation</span>
                            </button>
                        </div>
                        
                        <div class="px-5 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider">History</div>

                        <div id="conversation-list" class="flex-grow overflow-y-auto chat-messages px-3 pb-4 space-y-1">
                            </div>
                    </div>

                    <div id="active-chat-container" class="flex-1 flex flex-col h-full bg-slate-50/50 transition-all duration-300 ease-in-out ${currentConversationId ? 'flex' : 'hidden md:flex'} relative">
                         <div class="absolute inset-0 medical-pattern opacity-40 pointer-events-none z-0"></div>
                        </div>
                </div>
            `;
            lucide.createIcons();
            
            // Attach listeners for sidebar buttons
            document.getElementById('new-chat-btn')?.addEventListener('click', startNewConversation);
            document.getElementById('back-to-landing-btn')?.addEventListener('click', handleBackToLanding);

            // Render the dynamic parts
            renderHistoryList();
            renderActiveChat();
        }

        /**
         * Renders the list of past conversations in the left sidebar.
         */
        function renderHistoryList() {
            const listContainer = document.getElementById('conversation-list');
            if (!listContainer) return; // Guard clause
            
            if (allConversations.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-center px-4">
                        <i data-lucide="message-square-dashed" class="h-8 w-8 text-slate-300 mb-2"></i>
                        <p class="text-sm text-slate-500">No previous chats.</p>
                    </div>`;
                return;
            }

            // Generate HTML for each conversation item
            listContainer.innerHTML = allConversations.map(conv => {
                const isActive = conv.id === currentConversationId;
                const lastMsg = conv.lastMessage ? sanitizeHTML(conv.lastMessage) : 'New conversation';
                const title = sanitizeHTML(conv.title); // Sanitize for display
                
                // Active state styling vs inactive
                const baseClasses = "group relative w-full text-left p-3 rounded-xl transition-all duration-200 mb-1 border";
                const activeClasses = isActive 
                    ? "bg-white border-slate-200 shadow-sm z-10" 
                    : "hover:bg-slate-100 border-transparent hover:border-slate-100";
                
                return `
                    <div class="${baseClasses} ${activeClasses}">
                        <button class="w-full" onclick="handleSelectConversation('${conv.id}')">
                            <div class="flex items-center justify-between mb-1">
                                <h3 class="font-semibold text-sm ${isActive ? 'text-primary-700' : 'text-slate-700'} truncate pr-6">${title}</h3>
                                ${isActive ? '<div class="h-2 w-2 rounded-full bg-primary-500"></div>' : ''}
                            </div>
                            <p class="text-xs text-slate-500 truncate pr-4">${lastMsg}</p>
                        </button>
                        
                        <button class="conv-menu-btn absolute top-3 right-2 p-1 rounded-md text-slate-400 hover:text-slate-700 hover:bg-slate-200 opacity-0 group-hover:opacity-100 focus:opacity-100 transition-all" onclick="handleToggleConvMenu(event, '${conv.id}')">
                            <i data-lucide="more-horizontal" class="h-4 w-4 pointer-events-none"></i>
                        </button>

                        <div id="menu-${conv.id}" class="conv-menu-dropdown hidden absolute top-8 right-2 z-30 w-36 bg-white shadow-xl rounded-xl border border-slate-100 overflow-hidden animate-popIn">
                            <button class="w-full text-left px-4 py-2.5 text-xs font-medium text-slate-600 hover:bg-slate-50 flex items-center space-x-2 transition-colors" onclick="handleShareConversation(event, '${conv.id}')">
                                <i data-lucide="share-2" class="h-3.5 w-3.5"></i>
                                <span>Share</span>
                            </button>
                            <button class="w-full text-left px-4 py-2.5 text-xs font-medium text-slate-600 hover:bg-slate-50 flex items-center space-x-2 transition-colors" onclick="handleRenameConversation(event, '${conv.id}', '${sanitizeHTML(conv.title)}')"> 
                                <i data-lucide="edit-3" class="h-3.5 w-3.5"></i>
                                <span>Rename</span>
                            </button>
                            <div class="h-px bg-slate-100 my-0.5"></div>
                            <button class="w-full text-left px-4 py-2.5 text-xs font-medium text-emergency-600 hover:bg-emergency-50 flex items-center space-x-2 transition-colors" onclick="handleDeleteConversation(event, '${conv.id}')">
                                <i data-lucide="trash-2" class="h-3.5 w-3.5"></i>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons(); // Re-render icons after updating HTML
        }

        /**
         * Renders the active chat window (messages, input area, etc.)
         */
        function renderActiveChat() {
            const container = document.getElementById('active-chat-container');
            if (!container) return; // Guard clause

            // Handle the "empty state" (no chat selected)
            if (!currentConversationId) {
                container.innerHTML = `
                    <div class="flex flex-col h-full items-center justify-center text-center p-8 relative z-10">
                        <div class="absolute top-0 left-0 p-4 md:flex items-center space-x-3">
                            <button id="sidebar-toggle" class="text-slate-500 hover:text-slate-800 p-2 rounded-lg hover:bg-white/50 transition-colors" title="Toggle Menu">
                                <i data-lucide="panel-left" class="h-6 w-6"></i>
                            </button>
                        </div>
                        <div class="bg-white p-6 rounded-full shadow-soft mb-6 animate-popIn">
                             <div class="bg-primary-50 p-4 rounded-full">
                                <i data-lucide="bot" class="h-12 w-12 text-primary-600"></i>
                             </div>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Welcome to HealthBot AI</h2>
                        <p class="text-slate-500 max-w-md">Your intelligent health companion is ready. Select a conversation from the sidebar or start a new consultation.</p>
                        <button onclick="startNewConversation()" class="mt-8 bg-white text-primary-600 font-semibold py-2.5 px-6 rounded-full border border-primary-200 shadow-sm hover:shadow-md hover:border-primary-300 transition-all">
                            Start New Chat
                        </button>
                    </div>
                `;
                lucide.createIcons();
                // Attach listener for the toggle button in empty state
                document.getElementById('sidebar-toggle')?.addEventListener('click', handleToggleSidebar);
                return;
            }

            // Find the current conversation metadata
            const currentConv = allConversations.find(c => c.id === currentConversationId);
            const chatTitle = currentConv ? sanitizeHTML(currentConv.title) : 'New Consultation';

            // Render the full chat interface for the active conversation
            container.innerHTML = `
                <div class="p-4 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between flex-shrink-0 z-20 shadow-sm">
                    <div class="flex items-center space-x-3 overflow-hidden">
                        <button id="sidebar-toggle" class="hidden md:block text-slate-500 hover:text-primary-600 p-2 rounded-lg hover:bg-slate-100 transition-colors" title="Toggle Sidebar">
                            <i data-lucide="panel-left" class="h-5 w-5"></i>
                        </button>
                        <button id="back-to-history-btn" class="md:hidden text-slate-500 hover:text-primary-600 p-2 rounded-lg hover:bg-slate-100">
                            <i data-lucide="chevron-left" class="h-6 w-6"></i>
                        </button>
                        
                        <div class="flex flex-col overflow-hidden">
                            <span class="text-base font-bold text-slate-800 truncate leading-tight">${chatTitle}</span>
                            <span class="text-xs text-emerald-600 font-medium flex items-center gap-1">
                                <span class="relative flex h-1.5 w-1.5">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-emerald-500"></span>
                                </span>
                                Online & Ready
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        </div>
                </div>

                <div id="chat-messages" class="flex-grow overflow-y-auto p-4 md:p-6 space-y-6 chat-messages z-10">
                     <div class="flex justify-center mb-4">
                        <div class="bg-orange-50/80 backdrop-blur border border-orange-100 text-orange-800 text-xs py-2 px-4 rounded-full shadow-sm flex items-center gap-2 max-w-fit mx-auto">
                            <i data-lucide="shield-alert" class="h-3 w-3"></i>
                            <span>AI can make mistakes. Not medical advice. Call emergency for urgency.</span>
                        </div>
                    </div>
                    </div>

                <div class="p-4 md:p-6 z-20 flex-shrink-0">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-center flex-wrap gap-2 mb-4">
                             <button class="quick-action-btn bg-white hover:bg-primary-50 text-slate-600 hover:text-primary-700 text-xs font-medium py-2 px-4 rounded-full shadow-sm border border-slate-200 hover:border-primary-200 transition-all transform hover:-translate-y-0.5" data-message="What are common headache symptoms?">
                                Headache Symptoms
                            </button>
                            <button class="quick-action-btn bg-white hover:bg-primary-50 text-slate-600 hover:text-primary-700 text-xs font-medium py-2 px-4 rounded-full shadow-sm border border-slate-200 hover:border-primary-200 transition-all transform hover:-translate-y-0.5" data-message="Tell me about fever and illness.">
                                Fever Guide
                            </button>
                            <button class="quick-action-btn bg-white hover:bg-primary-50 text-slate-600 hover:text-primary-700 text-xs font-medium py-2 px-4 rounded-full shadow-sm border border-slate-200 hover:border-primary-200 transition-all transform hover:-translate-y-0.5" data-message="Analyze Rash Image">
                                <i data-lucide="image" class="inline-block h-3 w-3 mr-1"></i> Analyze Image
                            </button>
                        </div>
                        
                        <div id="file-preview-container" class="mb-2 px-2" style="display: none;">
                            <div id="file-previews" class="flex flex-wrap gap-2"></div>
                        </div>

                        <div class="bg-white p-2 rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-200 flex items-end gap-2 relative transition-all focus-within:ring-2 focus-within:ring-primary-100 focus-within:border-primary-300">
                            
                            <label for="file-upload" class="cursor-pointer flex-shrink-0 mb-1 ml-1">
                                <div class="text-slate-400 hover:text-primary-600 hover:bg-primary-50 p-2.5 rounded-full transition-colors" title="Upload Image">
                                    <i data-lucide="paperclip" class="h-5 w-5"></i>
                                </div>
                            </label>
                            <input type="file" id="file-upload" class="hidden" multiple accept="image/*">

                            <textarea id="chat-input"
                                class="textarea-auto-resize flex-grow py-3 px-2 bg-transparent border-none focus:ring-0 text-slate-700 placeholder:text-slate-400 text-base"
                                placeholder="Describe your symptoms..."
                                rows="1"
                                style="min-height: 3rem; max-height: 10rem;"
                            ></textarea>
                            
                            ${SpeechRecognition ? `
                            <button id="mic-btn"
                                class="flex-shrink-0 mb-1 text-slate-400 hover:text-slate-700 hover:bg-slate-100 p-2.5 rounded-full transition-colors" title="Voice Input">
                                <i data-lucide="mic" class="h-5 w-5"></i>
                            </button>
                            ` : ''}
                            
                            <button id="send-btn"
                                class="flex-shrink-0 mb-1 bg-slate-900 hover:bg-primary-600 text-white p-2.5 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 hover:rotate-12 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="send" class="h-5 w-5 ml-0.5"></i>
                            </button>
                        </div>
                         <div class="text-center mt-2">
                            <span class="text-[10px] text-slate-400">Powered by HealthBot AI. Your data is processed securely.</span>
                        </div>
                    </div>
                </div>
            `;

            lucide.createIcons();
            displayMessages(); // Populate the messages for this conversation
            setupChatEventListeners(); // Re-attach listeners for inputs/buttons in active chat
        }

        /**
         * Renders the messages for the currently active conversation.
         */
        function displayMessages() {
            const chatMessagesDiv = document.getElementById('chat-messages');
            if (!chatMessagesDiv) return; // Guard if element not found

            chatMessagesDiv.innerHTML = ''; // Clear previous messages
            
             // Re-insert disclaimer at top (cleared by innerHTML='')
            const disclaimerHTML = `
                <div class="flex justify-center mb-6">
                    <div class="bg-orange-50/80 backdrop-blur border border-orange-100 text-orange-800 text-xs font-medium py-1.5 px-4 rounded-full shadow-sm flex items-center gap-2 max-w-fit mx-auto">
                        <i data-lucide="shield-alert" class="h-3 w-3"></i>
                        <span>AI provides info, not medical diagnosis. In emergency, call 108/911.</span>
                    </div>
                </div>`;
            chatMessagesDiv.innerHTML = disclaimerHTML;

            // Display placeholder if no messages and not loading
            if (currentConversationMessages.length === 0 && !isLoading) {
                 // Already handled by disclaimer + empty state is implicit, but let's add a starter nudge
            }

            // Render each message
            currentConversationMessages.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                const isUser = message.sender === 'user';
                
                messageDiv.className = `flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'} ${isUser ? 'animate-slideInRight' : 'animate-slideInLeft'}`;
                
                // Avatar Logic
                const avatar = isUser 
                    ? `<div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 ml-3 flex-shrink-0 self-end mb-1"><i data-lucide="user" class="h-4 w-4"></i></div>`
                    : `<div class="w-8 h-8 rounded-full bg-primary-600 flex items-center justify-center text-white mr-3 flex-shrink-0 self-start mt-1 shadow-md shadow-primary-600/20"><i data-lucide="bot" class="h-5 w-5"></i></div>`;

                let bubbleClasses = '';
                if (isUser) {
                    // User Bubble: Gradient
                    bubbleClasses = 'bg-gradient-to-br from-slate-800 to-slate-900 text-white rounded-2xl rounded-tr-sm shadow-md';
                } else if (message.isEmergency) {
                    // Emergency Bubble
                    bubbleClasses = 'bg-emergency-50 border border-emergency-200 text-slate-800 rounded-2xl rounded-tl-sm shadow-soft';
                } else {
                    // AI Bubble: White Card style
                    bubbleClasses = 'bg-white border border-slate-100 text-slate-700 rounded-2xl rounded-tl-sm shadow-soft';
                }

                const timestamp = message.timestamp ? new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                
                const contentHtml = `
                    <div class="max-w-[85%] md:max-w-[75%] group flex ${isUser ? 'flex-row-reverse' : 'flex-row'} items-end">
                        ${!isUser ? avatar : ''}
                        <div class="relative px-5 py-3.5 ${bubbleClasses}">
                            ${message.isEmergency ? `
                                <div class="flex items-center gap-2 text-emergency-700 font-bold mb-2 border-b border-emergency-200 pb-2">
                                    <i data-lucide="alert-octagon" class="h-4 w-4"></i> EMERGENCY DETECTED
                                </div>
                            ` : ''}
                            
                            ${message.filePreview ? `
                            <div class="mb-3">
                                <img src="${message.filePreview}" alt="Uploaded image" class="rounded-lg shadow-sm max-h-64 border border-white/20 cursor-pointer hover:opacity-95 transition-opacity" onclick="window.open('${message.filePreview}')">
                            </div>
                            ` : ''}
                            
                            <div class="prose prose-sm max-w-none ${isUser ? 'text-slate-100 prose-invert' : 'text-slate-700 prose-headings:text-slate-900 prose-strong:text-slate-900 prose-a:text-primary-600'}">
                                ${markdownToHtml(message.text)}
                            </div>
                            
                            <div class="text-[10px] mt-1.5 opacity-60 ${isUser ? 'text-right text-slate-300' : 'text-left text-slate-400'} uppercase tracking-wide font-medium">
                                ${timestamp}
                            </div>
                        </div>
                         ${isUser ? avatar : ''}
                    </div>
                `;
                
                messageDiv.innerHTML = contentHtml;
                chatMessagesDiv.appendChild(messageDiv);
            });

            // Add typing indicator if loading
            if (isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = "flex w-full justify-start animate-fadeInSlideUp";
                loadingDiv.innerHTML = `
                     <div class="flex items-end max-w-[75%]">
                        <div class="w-8 h-8 rounded-full bg-primary-600 flex items-center justify-center text-white mr-3 flex-shrink-0 shadow-md shadow-primary-600/20"><i data-lucide="bot" class="h-5 w-5"></i></div>
                        <div class="bg-white border border-slate-100 text-slate-800 px-5 py-4 rounded-2xl rounded-tl-sm shadow-soft">
                            <div class="flex items-center dot-animation space-x-1.5">
                                <span class="w-2 h-2 bg-primary-400 rounded-full"></span>
                                <span class="w-2 h-2 bg-primary-500 rounded-full"></span>
                                <span class="w-2 h-2 bg-primary-600 rounded-full"></span>
                            </div>
                        </div>
                    </div>
                `;
                chatMessagesDiv.appendChild(loadingDiv);
            }
            
            lucide.createIcons(); // Ensure icons in messages render
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
        }

        // --- Event Handlers ---

        function startChat() {
            currentView = 'chat';
            loadAllConversations(); // Load saved conversation list
            
            if (allConversations.length === 0) {
                startNewConversation(false); 
            } else {
                currentConversationId = allConversations[0].id;
                currentConversationMessages = loadConversationMessages(currentConversationId);
            }
            
            renderChatLayout(); 
        }

        function startNewConversation(renderLayout = true) {
            const newId = 'conv-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5); 
            currentConversationId = newId;
            currentConversationMessages = [{
                text: "Hello! I'm **HealthBot AI**. \n\nI can help analyze symptoms, answer medical questions, or identify visual skin/pill issues. \n\n*How are you feeling today?*",
                sender: 'ai',
                timestamp: Date.now(),
                isEmergency: false
            }];
            
            const newConv = {
                id: newId,
                title: 'New Consultation ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit'}),
                lastMessage: 'Hello! I\'m HealthBot AI...',
                timestamp: Date.now()
            };
            
            allConversations.unshift(newConv); 
            
            saveAllConversations();
            saveCurrentConversationMessages();
            
            if (renderLayout) {
                renderChatLayout(); 
            } else {
                renderHistoryList();
                renderActiveChat();
            }
            
            showChatView();
        }

        function handleSelectConversation(convId) {
            if (convId === currentConversationId) {
                showChatView(); 
                return; 
            }

            currentConversationId = convId; 
            currentConversationMessages = loadConversationMessages(convId); 
            
            renderHistoryList();
            renderActiveChat();

            showChatView();
        }

        function handleBackToLanding() {
            currentView = 'landing';
            currentConversationId = null;
            currentConversationMessages = [];
            allConversations = []; 
            renderLandingPage(); 
        }

        function handleBackToHistory() {
            const historySidebar = document.getElementById('chat-history-sidebar');
            const activeChat = document.getElementById('active-chat-container');
            if (historySidebar && activeChat) {
                historySidebar.classList.remove('hidden');
                historySidebar.classList.add('flex');
                activeChat.classList.add('hidden');
                activeChat.classList.remove('flex'); 
            }
        }

        function showChatView() {
            if (window.innerWidth < 768) { 
                 const historySidebar = document.getElementById('chat-history-sidebar');
                 const activeChat = document.getElementById('active-chat-container');
                 if (historySidebar && activeChat) {
                    historySidebar.classList.add('hidden');
                    historySidebar.classList.remove('flex');
                    activeChat.classList.remove('hidden');
                    activeChat.classList.add('flex');
                 }
            }
        }

        // --- Sidebar and Menu Handlers ---

        function handleToggleSidebar() {
            isSidebarCollapsed = !isSidebarCollapsed;
            const sidebar = document.getElementById('chat-history-sidebar');
            
            if (sidebar) {
                if (isSidebarCollapsed) {
                    sidebar.classList.remove('md:w-80', 'md:visible', 'md:opacity-100');
                    sidebar.classList.add('md:w-0', 'md:overflow-hidden', 'md:invisible', 'md:opacity-0');
                } else {
                    sidebar.classList.remove('md:w-0', 'md:overflow-hidden', 'md:invisible', 'md:opacity-0');
                    sidebar.classList.add('md:w-80', 'md:visible', 'md:opacity-100');
                }
            }
        }

        function handleToggleConvMenu(event, convId) {
            event.stopPropagation(); 
            const menu = document.getElementById(`menu-${convId}`);
            if (menu) {
                const isHidden = menu.classList.toggle('hidden');
                document.querySelectorAll('.conv-menu-dropdown').forEach(m => {
                    if (m.id !== `menu-${convId}`) {
                        m.classList.add('hidden');
                    }
                });
            }
        }
        
        function handleShareConversation(event, convId) {
            event.stopPropagation(); 
            const messagesToShare = loadConversationMessages(convId);
            const convMeta = allConversations.find(c => c.id === convId);
            const title = convMeta ? convMeta.title : 'Chat History';
            
            let chatText = `Conversation: ${title}\n`;
            chatText += `Shared on: ${new Date().toLocaleString()}\n`;
            chatText += "========================================\n\n";

            messagesToShare.forEach(msg => {
                const prefix = msg.sender === 'user' ? '[User]' : '[HealthBot AI]';
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                chatText += `${prefix} (${time}):\n${msg.text}\n\n`; 
                if (msg.filePreview) chatText += `[User Uploaded Image]\n\n`;
            });

            const textArea = document.createElement('textarea');
            textArea.value = chatText;
            textArea.style.position = 'fixed'; 
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    displayMessageBox('Conversation copied to clipboard!', 'success');
                } else {
                     displayMessageBox('Failed to copy chat (execCommand failed).', 'error');
                }
            } catch (err) {
                console.error('Clipboard copy failed:', err);
                displayMessageBox('Failed to copy chat.', 'error');
            }
            document.body.removeChild(textArea);
            
            const menu = document.getElementById(`menu-${convId}`);
            if (menu) menu.classList.add('hidden');
        }

        function handleRenameConversation(event, convId, currentTitle) {
            event.stopPropagation();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentTitle;
            const rawTitle = tempDiv.textContent || tempDiv.innerText || "";
            
            renderRenameModal(convId, rawTitle);
            
            const menu = document.getElementById(`menu-${convId}`);
            if (menu) menu.classList.add('hidden');
        }

        function handleDeleteConversation(event, convId) {
            event.stopPropagation();
            renderConfirmationModal(
                'Delete Chat?',
                'Are you sure you want to delete this conversation? This action cannot be undone.',
                () => { 
                    deleteConversationFromStorage(convId);
                    
                    if (currentConversationId === convId) {
                        currentConversationId = null;
                        currentConversationMessages = [];
                        if (allConversations.length > 0) {
                             handleSelectConversation(allConversations[0].id);
                        } else {
                             renderActiveChat();
                        }
                    }
                    renderHistoryList();
                }
            );
            const menu = document.getElementById(`menu-${convId}`);
            if (menu) menu.classList.add('hidden');
        }

        // --------------------------------------------------

        async function handleSendMessage(text) {
            const messageText = text ? text.trim() : ""; 
            const hasFiles = uploadedFiles.length > 0;

            if ((!messageText && !hasFiles) || isLoading || !currentConversationId) {
                if (!currentConversationId) displayMessageBox('Please start or select a conversation first.', 'info');
                else if (!messageText && !hasFiles) displayMessageBox('Please type a message or upload a file.', 'info');
                return;
            }

            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.value = '';
                adjustTextareaHeight();
            }

            const userMessage = {
                text: messageText,
                sender: 'user',
                timestamp: Date.now()
            };
            
            if (hasFiles) {
                userMessage.files = uploadedFiles; 
                userMessage.filePreview = uploadedFiles[0].preview;
                userMessage.fileType = uploadedFiles[0].type;
            }

            currentConversationMessages.push(userMessage);
            displayMessages(); 
            isLoading = true;
            displayMessages(); // Show typing indicator

            const filesToSend = [...uploadedFiles];
            uploadedFiles = []; 
            const previewContainer = document.getElementById('file-preview-container');
            const previews = document.getElementById('file-previews');
            if (previewContainer && previews) {
                 previewContainer.style.display = 'none';
                 previews.innerHTML = '';
            }

            const activeConv = allConversations.find(c => c.id === currentConversationId);
            if (activeConv) {
                if (activeConv.title.startsWith('New Consultation') && messageText) {
                    activeConv.title = messageText.substring(0, 25) + (messageText.length > 25 ? '...' : '');
                }
                activeConv.lastMessage = messageText 
                    ? (messageText.substring(0, 40) + (messageText.length > 40 ? '...' : '')) 
                    : (filesToSend.length > 0 ? 'Image sent' : '...');
                activeConv.timestamp = Date.now();
                saveAllConversations();
                renderHistoryList();
            }

            const emergencyKeywords = ['emergency', '108', 'help me', 'dying', 'chest pain', 'difficulty breathing', 'severe bleeding', 'unconscious', 'suicide', 'kill myself'];
            if (emergencyKeywords.some(keyword => messageText.toLowerCase().includes(keyword))) {
                const emergencyResponse = {
                    text: "⚠️ **Emergency Detected!** \n\nIf this is a medical emergency, please **call 108 or your local emergency number immediately.** \n\nThis AI cannot provide emergency assistance.",
                    sender: 'ai',
                    timestamp: Date.now(),
                    isEmergency: true
                };
                currentConversationMessages.push(emergencyResponse);
                saveCurrentConversationMessages();
                isLoading = false;
                displayMessages();
                return;
            }

            // --- Send to Backend ---
            try {
                const backendChatHistory = currentConversationMessages.slice(0, -1).map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text || "" }] 
                }));
                
                const payload = {
                    userId: userId,
                    conversationId: currentConversationId,
                    message: messageText,
                    files: filesToSend,
                    chatHistory: backendChatHistory
                };
                
                const response = await exponentialBackoffFetch(`${BACKEND_API_URL}chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                let aiResponseText;

                if (result.aiResponse || result.aiResponse === "") { 
                    aiResponseText = result.aiResponse;
                } else if (result.error) {
                      aiResponseText = "An error occurred on the backend: " + result.error;
                      console.error("Backend Error:", result.error);
                } else { 
                    aiResponseText = "I'm sorry, I couldn't get a valid response. Please try again.";
                    console.error("Invalid backend response:", result);
                }

                // Add AI response to messages
                currentConversationMessages.push({
                    text: aiResponseText || "", 
                    sender: 'ai',
                    timestamp: Date.now(),
                    isEmergency: false,
                });

                // Update metadata again with AI's response preview
                if (activeConv) {
                    let lastMsgPreview = (aiResponseText || "").substring(0, 40) + ((aiResponseText || "").length > 40 ? '...' : '');
                    activeConv.lastMessage = lastMsgPreview;
                    activeConv.timestamp = Date.now();
                    saveAllConversations();
                    renderHistoryList();
                }

            } catch (error) {
                console.error("Error communicating with backend:", error);
                currentConversationMessages.push({
                    text: `Sorry, I couldn't connect to the AI service. Please check if the backend is running. (Error: ${error.message})`,
                    sender: 'ai',
                    timestamp: Date.now(),
                    isEmergency: false 
                });
            } finally {
                isLoading = false;
                saveCurrentConversationMessages();
                displayMessages();
            }
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            uploadedFiles = [];
            const previewContainer = document.getElementById('file-previews');
            const containerDiv = document.getElementById('file-preview-container');

            if (!previewContainer || !containerDiv) return;

            previewContainer.innerHTML = '';
            containerDiv.style.display = 'block';
            
            const file = files[0]; 

            if (!file.type.startsWith("image/")) {
                displayMessageBox("Only image files (JPEG, PNG, GIF, etc.) are allowed.", "error");
                containerDiv.style.display = 'none';
                event.target.value = null;
                return;
            }

            const maxSizeMB = 5;
            if (file.size > maxSizeMB * 1024 * 1024) {
                 displayMessageBox(`File size exceeds the ${maxSizeMB}MB limit.`, "error");
                 containerDiv.style.display = 'none';
                 event.target.value = null;
                 return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = e.target.result;
                uploadedFiles = [{
                    name: file.name, 
                    type: file.type,
                    size: file.size, 
                    preview: preview
                }];

                const filePreviewDiv = document.createElement('div');
                filePreviewDiv.className = 'relative flex items-center p-1.5 rounded-lg bg-white border border-slate-200 shadow-sm pr-8';
                filePreviewDiv.innerHTML = `
                    <img src="${preview}" alt="Preview" class="w-10 h-10 object-cover rounded-md mr-2"> 
                    <span class="truncate text-xs font-medium text-slate-600 max-w-[100px]">${sanitizeHTML(file.name)}</span>`;
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = `<i data-lucide="x" class="h-3 w-3"></i>`;
                removeBtn.className = 'absolute top-1/2 -translate-y-1/2 right-2 p-1 rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition-colors';
                removeBtn.onclick = () => {
                    uploadedFiles = [];
                    filePreviewDiv.remove();
                    containerDiv.style.display = 'none';
                    event.target.value = null;
                };
                
                filePreviewDiv.appendChild(removeBtn);
                previewContainer.appendChild(filePreviewDiv);
                lucide.createIcons();
            };
             reader.onerror = (e) => {
                console.error("FileReader error:", e);
                displayMessageBox("Error reading file.", "error");
                containerDiv.style.display = 'none';
                 event.target.value = null;
            };
            reader.readAsDataURL(file);
        }

        function toggleVoiceInput() {
            if (!recognition) {
                displayMessageBox("Voice input is not supported by your browser.", 'error');
                return;
            }
            if (isRecording) { recognition.stop(); }
            else { 
                try {
                    recognition.start(); 
                } catch (e) {
                    console.error("Speech recognition start error:", e);
                    displayMessageBox(`Could not start voice input: ${e.message}`, 'error');
                    isRecording = false;
                    updateMicButtonState();
                }
            }
        }

        function updateMicButtonState() {
            const micBtn = document.getElementById('mic-btn');
            if (micBtn) {
                const micIcon = micBtn.querySelector('i[data-lucide]');
                if (isRecording) {
                    micBtn.classList.add('bg-emergency-50', 'text-emergency-600', 'mic-recording-pulse');
                    micBtn.classList.remove('bg-slate-100', 'text-slate-400');
                    if (micIcon) micIcon.setAttribute('data-lucide', 'mic-off');
                } else {
                    micBtn.classList.remove('bg-emergency-50', 'text-emergency-600', 'mic-recording-pulse');
                    micBtn.classList.add('bg-slate-100', 'text-slate-400');
                    if (micIcon) micIcon.setAttribute('data-lucide', 'mic');
                }
                lucide.createIcons(); 
            }
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('chat-input');
            if (textarea) {
                textarea.style.height = 'auto';
                const maxHeight = parseInt(textarea.style.maxHeight || '160', 10); 
                textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
            }
        }

        /**
         * Attaches event listeners for the active chat input area.
         */
        function setupChatEventListeners() {
            const sendBtn = document.getElementById('send-btn');
            const fileUpload = document.getElementById('file-upload');
            const chatInput = document.getElementById('chat-input');
            const micBtn = document.getElementById('mic-btn');

            if (sendBtn) {
                sendBtn.replaceWith(sendBtn.cloneNode(true));
                document.getElementById('send-btn').addEventListener('click', () => {
                    const currentChatInput = document.getElementById('chat-input');
                    handleSendMessage(currentChatInput ? currentChatInput.value : "");
                });
            }

            if (fileUpload) {
                 fileUpload.replaceWith(fileUpload.cloneNode(true));
                 document.getElementById('file-upload').addEventListener('change', handleFileUpload);
            }
            
            if (chatInput) {
                chatInput.replaceWith(chatInput.cloneNode(true));
                const newChatInput = document.getElementById('chat-input');
                
                newChatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage(newChatInput.value);
                    }
                });
                newChatInput.addEventListener('input', adjustTextareaHeight);
            }

            if (micBtn) {
                 micBtn.replaceWith(micBtn.cloneNode(true));
                 document.getElementById('mic-btn').addEventListener('click', toggleVoiceInput);
            }

            const backToHistoryBtn = document.getElementById('back-to-history-btn');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle');

            if (backToHistoryBtn) {
                 backToHistoryBtn.replaceWith(backToHistoryBtn.cloneNode(true));
                 document.getElementById('back-to-history-btn').addEventListener('click', handleBackToHistory);
            }
            if (sidebarToggleBtn) {
                 sidebarToggleBtn.replaceWith(sidebarToggleBtn.cloneNode(true));
                 document.getElementById('sidebar-toggle').addEventListener('click', handleToggleSidebar);
            }

            // --- Quick Action Buttons ---
            document.querySelectorAll('.quick-action-btn').forEach(button => {
                 const newButton = button.cloneNode(true);
                 button.parentNode.replaceChild(newButton, button);

                 newButton.addEventListener('click', (e) => {
                    const message = e.target.dataset.message || e.target.closest('button').dataset.message;
                    const currentChatInput = document.getElementById('chat-input');
                    const currentFileUpload = document.getElementById('file-upload');
                    
                    if (message === "Analyze Rash Image") {
                        if (currentChatInput) currentChatInput.value = "Please analyze this image.";
                        if (currentFileUpload) currentFileUpload.click();
                    } 
                    else { // For all other buttons
                        if (currentChatInput) currentChatInput.value = message;
                        handleSendMessage(message);
                    }
                    if (currentChatInput) adjustTextareaHeight();
                });
            });
        }


        // --- Initial Application Load ---
        renderLandingPage(); // Start with the landing page

    </script>
</body>

</html>



