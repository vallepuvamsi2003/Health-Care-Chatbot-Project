<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthBot AI - Your Personal Healthcare Assistant</title>
    
    <!-- FAVICON LINK: -->
    <link rel="icon" type="image/png" href="C:\Users\valle\Documents\MINI Project\medical-robot (1).png">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Base font */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar */
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-track { background: #f8f8f8; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* Style for textarea auto-resizing */
        .textarea-auto-resize { overflow: hidden; resize: none; }

        /* --- Animations --- */
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInSlideUp { animation: fadeInSlideUp 0.5s ease-out forwards; }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slideInLeft { animation: slideInLeft 0.3s ease-out forwards; }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-slideInRight { animation: slideInRight 0.3s ease-out forwards; }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-popIn { animation: popIn 0.3s ease-out forwards; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .dot-animation span { animation: bounce 0.7s infinite alternate; }
        .dot-animation span:nth-child(2) { animation-delay: 0.2s; }
        .dot-animation span:nth-child(3) { animation-delay: 0.4s; }

        .hero-glow::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 150%; height: 150%;
            background: radial-gradient(circle at center, hsla(175, 70%, 80%, 0.15) 0%, transparent 60%);
            animation: pulseGlow 12s infinite ease-in-out;
            z-index: 0; pointer-events: none; transform: translate(-50%, -50%);
        }
        @keyframes pulseGlow {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.7; }
        }

        @keyframes micPulse {
            0% { box-shadow: 0 0 0 0px rgba(239, 68, 68, 0.7); }
            100% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        .mic-recording-pulse { animation: micPulse 1.5s infinite; }
        
        @keyframes subtlePulse {
           0%, 100% { transform: scale(1); }
           50% { transform: scale(1.1); }
        }
        .animate-subtle-pulse { animation: subtlePulse 2.5s infinite ease-in-out; }

        /* Accessibility: Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .animate-fadeInSlideUp, .animate-slideInLeft, .animate-slideInRight,
            .animate-popIn, .dot-animation span, .hero-glow::before,
            .mic-recording-pulse, .animate-subtle-pulse, .transition-all,
            .transition, .transition-colors, .transition-transform {
                animation: none !important;
                transition: none !important;
            }
            .hover\:scale-105:hover, .hover\:scale-110:hover, .hover\:-translate-y-1:hover {
                transform: none !important;
            }
        }
    </style>
    <script>
        // Custom Tailwind CSS Configuration
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4',
                            300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6',
                            600: '#0d9488', 700: '#0f766e', 800: '#115e59',
                            900: '#134e4a', 950: '#042f2e',
                        },
                        'secondary': { 50: '#f5faff', 100: '#eef6ff', 200: '#d9eaff' },
                        'warning': {
                            50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a',
                            700: '#b45309', 800: '#92400e',
                        },
                        'emergency': {
                            50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca',
                            600: '#dc2626', 700: '#b91c1c', 800: '#991b1b',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-secondary-50 text-gray-900 antialiased">
    <!-- Container for custom message boxes -->
    <div id="message-box-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] flex flex-col items-center space-y-2 pointer-events-none"></div>

    <!-- Container for dynamic modals -->
    <div id="modal-container"></div>

    <div id="app" class="flex flex-col min-h-screen">
        <!-- App content will be rendered here by JavaScript -->
    </div>

    <script>
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // Global listener to close open menus
            document.body.addEventListener('click', (e) => {
                const menuButton = e.target.closest('.conv-menu-btn');
                document.querySelectorAll('.conv-menu-dropdown').forEach(menu => {
                    if (!menuButton || !menu.contains(menuButton)) {
                        menu.classList.add('hidden');
                    }
                });
            });
        });

        const appContainer = document.getElementById('app');
        let currentView = 'landing';
        let userId = 'user-' + Math.random().toString(36).substr(2, 9);
        let allConversations = []; // Stores metadata { id, title, lastMessage, timestamp }
        let currentConversationId = null; // ID of the active chat
        let currentConversationMessages = []; // Stores messages { text, sender, timestamp, ... } for the active chat
        let isLoading = false;
        let isRecording = false;
        let uploadedFiles = [];
        let isSidebarCollapsed = false; // State for collapsible sidebar

        // Backend API URL
        const BACKEND_API_URL = 'http://127.0.0.1:5000/';

        // Web Speech API setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            recognition.onstart = () => { isRecording = true; updateMicButtonState(); };
            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                const chatInput = document.getElementById('chat-input');
                if (chatInput) { chatInput.value = speechResult; adjustTextareaHeight(); }
            };
            recognition.onend = () => { isRecording = false; updateMicButtonState(); };
            recognition.onerror = (event) => {
                isRecording = false;
                updateMicButtonState();
                displayMessageBox(`Voice input error: ${event.error}.`, 'error');
            };
        } else {
            console.warn("Web Speech API not supported in this browser.");
        }


        // --- Utility Functions ---

        function sanitizeHTML(str) {
            if (!str) return ""; // Handle null or undefined strings
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function markdownToHtml(markdownText) {
            let html = sanitizeHTML(markdownText);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');       // Italic
            html = html.replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-2 rounded text-sm my-2 overflow-x-auto"><code>$1</code></pre>'); // Code blocks
            html = html.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 rounded text-sm">$1</code>'); // Inline code
            html = html.replace(/\n/g, '<br>'); // Line breaks
            return html;
        }

        async function exponentialBackoffFetch(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return exponentialBackoffFetch(url, options, retries - 1, delay * 2);
                } else {
                    console.error("Fetch failed after multiple retries:", error);
                    throw error; // Re-throw the error after final retry
                }
            }
        }

        function displayMessageBox(message, type = 'info') {
            const container = document.getElementById('message-box-container');
            if (!container) return; // Exit if container not found
            const messageBox = document.createElement('div');
            messageBox.className = `p-3 rounded-lg shadow-lg text-white pointer-events-auto flex items-center space-x-2 animate-popIn`;
            let icon = 'info';
            if (type === 'error') { messageBox.classList.add('bg-emergency-600'); icon = 'alert-triangle'; }
            else if (type === 'success') { messageBox.classList.add('bg-primary-600'); icon = 'check-circle'; }
            else { messageBox.classList.add('bg-blue-600'); } // Default info
            messageBox.innerHTML = `<i data-lucide="${icon}" class="h-5 w-5"></i> <span>${sanitizeHTML(message)}</span>`;
            container.appendChild(messageBox);
            lucide.createIcons(); // Ensure icon renders
            // Auto-remove after 3 seconds
            setTimeout(() => {
                messageBox.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                messageBox.addEventListener('transitionend', () => messageBox.remove());
            }, 3000);
        }

        // --- Custom Modal Functions ---
        function renderConfirmationModal(title, message, onConfirm) {
            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) return;
            const modalId = 'modal-' + Math.random().toString(36).substr(2, 9);
            
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 animate-fadeInSlideUp';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                    <h3 class="text-lg font-semibold text-gray-900">${sanitizeHTML(title)}</h3>
                    <p class="mt-2 text-sm text-gray-600">${sanitizeHTML(message)}</p>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="cancel-${modalId}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors">Cancel</button>
                        <button id="confirm-${modalId}" class="bg-emergency-600 hover:bg-emergency-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">Delete</button>
                    </div>
                </div>
            `;
            modalContainer.appendChild(modal);

            const closeModal = () => modalContainer.removeChild(modal);
            document.getElementById(`cancel-${modalId}`).addEventListener('click', closeModal);
            document.getElementById(`confirm-${modalId}`).addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
        }

        function renderRenameModal(convId, currentTitle) {
            const modalContainer = document.getElementById('modal-container');
             if (!modalContainer) return;
            const modalId = 'modal-' + Math.random().toString(36).substr(2, 9);
            
            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 animate-fadeInSlideUp';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
                    <h3 class="text-lg font-semibold text-gray-900">Rename Conversation</h3>
                    <p class="mt-2 text-sm text-gray-600">Enter a new name for this conversation.</p>
                    <input id="rename-input-${modalId}" type="text" class="mt-4 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500" value="${sanitizeHTML(currentTitle)}">
                    <div class="mt-6 flex justify-end space-x-3">
                        <button id="cancel-${modalId}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors">Cancel</button>
                        <button id="save-${modalId}" class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">Save</button>
                    </div>
                </div>
            `;
            modalContainer.appendChild(modal);

            const closeModal = () => modalContainer.removeChild(modal);
            document.getElementById(`cancel-${modalId}`).addEventListener('click', closeModal);
            document.getElementById(`save-${modalId}`).addEventListener('click', () => {
                const newTitleInput = document.getElementById(`rename-input-${modalId}`);
                const newTitle = newTitleInput ? newTitleInput.value.trim() : "";
                if (newTitle) {
                    const conv = allConversations.find(c => c.id === convId);
                    if (conv) {
                        conv.title = newTitle;
                        saveAllConversations();
                        renderHistoryList(); // Update the list display
                        // If renaming the active chat, update its header
                        if (convId === currentConversationId) {
                            renderActiveChat(); // Re-render the chat window to update title
                        }
                    }
                    closeModal();
                } else {
                    displayMessageBox("Please enter a valid name.", "error");
                }
            });
        }

        // --- Data Persistence (localStorage) ---
        function saveAllConversations() {
            allConversations.sort((a, b) => b.timestamp - a.timestamp); // Keep sorted by most recent
            localStorage.setItem('healthBotConversations', JSON.stringify(allConversations));
        }

        function saveCurrentConversationMessages() {
            if (currentConversationId) {
                localStorage.setItem(`healthBot_${currentConversationId}`, JSON.stringify(currentConversationMessages));
            }
        }

        function loadAllConversations() {
            allConversations = JSON.parse(localStorage.getItem('healthBotConversations')) || [];
            allConversations.sort((a, b) => b.timestamp - a.timestamp); // Ensure sorted on load
        }

        function loadConversationMessages(convId) {
            return JSON.parse(localStorage.getItem(`healthBot_${convId}`)) || [];
        }

        function deleteConversationFromStorage(convId) {
            localStorage.removeItem(`healthBot_${convId}`); // Remove messages
            allConversations = allConversations.filter(c => c.id !== convId); // Remove metadata
            saveAllConversations(); // Save updated metadata list
        }

        // --- Component Rendering Functions ---

        function renderLandingPage() {
            appContainer.innerHTML = `
                <header class="fixed top-0 left-0 right-0 z-20 bg-white/80 backdrop-blur-md shadow-sm py-4 px-6 flex items-center justify-between rounded-b-xl border-b border-gray-100 animate-fadeInSlideUp">
                    <div class="flex items-center space-x-2">
                        <i data-lucide="heart-pulse" class="h-7 w-7 text-primary-600 animate-subtle-pulse"></i>
                        <span class="text-2xl font-bold text-gray-800">HealthBot AI</span>
                    </div>
                    <nav class="hidden md:flex items-center space-x-6">
                        <a href="#features" class="text-gray-600 hover:text-primary-600 font-medium transition-colors duration-300">Features</a>
                        <a href="#how-it-works" class="text-gray-600 hover:text-primary-600 font-medium transition-colors duration-300">How It Works</a>
                        <a href="#safety" class="text-gray-600 hover:text-primary-600 font-medium transition-colors duration-300">Safety</a>
                        <button id="start-chat-nav-btn"
                            class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2 px-5 rounded-full shadow-md transition-all duration-300 transform hover:scale-105 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary-300">
                            Start Chat
                        </button>
                    </nav>
                    <button class="md:hidden text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <i data-lucide="menu" class="h-7 w-7"></i>
                    </button>
                </header>

                <main class="flex-grow pt-20">
                    <!-- Hero Section -->
                    <section class="relative bg-gradient-to-b from-secondary-100 to-secondary-50 py-20 md:py-32 text-center overflow-hidden rounded-b-3xl shadow-lg hero-glow">
                        <div class="relative z-10 max-w-4xl mx-auto px-6 animate-fadeInSlideUp" style="animation-delay: 0.1s;">
                            <span class="inline-block bg-primary-100 text-primary-700 text-sm font-semibold px-4 py-2 rounded-full mb-4 shadow-sm transform hover:scale-105 transition-transform duration-300">
                                AI-Powered Healthcare Assistant
                            </span>
                            <h1 class="text-4xl md:text-6xl font-extrabold mb-4 leading-tight drop-shadow-sm text-gray-900">
                                Your Personal <span class="text-primary-600">Healthcare</span> Assistant, 24/7
                            </h1>
                            <p class="text-lg md:text-xl mb-8 opacity-90 max-w-2xl mx-auto drop-shadow-sm text-gray-700">
                                Get instant, AI-powered health guidance. Please remember to always consult a professional for medical advice.
                            </p>
                            <div class="bg-warning-50 text-warning-800 p-4 rounded-lg shadow-inner max-w-2xl mx-auto mb-10 text-left border border-warning-200 transform hover:scale-[1.01] transition-transform duration-300">
                                <i data-lucide="alert-triangle" class="inline-block mr-2 h-5 w-5 text-warning-700"></i>
                                <span class="font-medium">Medical Disclaimer:</span> This AI assistant provides general health information only. Always consult
                                with qualified healthcare professionals for medical advice, diagnosis, or treatment.
                            </div>
                            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                                <button id="start-consultation-btn"
                                    class="bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-primary-300">
                                    Start Free Consultation
                                </button>
                                <a href="#how-it-works"
                                    class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-800 font-semibold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-gray-200">
                                    Learn How It Works
                                </a>
                            </div>
                        </div>
                    </section>

                    <!-- Features Section -->
                    <section id="features" class="py-16 bg-white px-6">
                        <div class="max-w-6xl mx-auto text-center">
                            <h2 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-4 animate-fadeInSlideUp">Advanced Healthcare AI Features</h2>
                            <p class="text-lg text-gray-600 mb-12 max-w-3xl mx-auto animate-fadeInSlideUp" style="animation-delay: 0.1s;">
                                Our AI assistant combines medical knowledge with natural language
                                processing to provide comprehensive health support.
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center border border-gray-100 transform hover:-translate-y-1 animate-fadeInSlideUp" style="animation-delay: 0.2s;">
                                    <div class="flex justify-center mb-4"><i data-lucide="stethoscope" class="h-10 w-10 text-primary-500"></i></div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Symptom Analysis</h3>
                                    <p class="text-gray-600">Describe your symptoms and get AI-powered analysis with potential causes and recommendations.</p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center border border-gray-100 transform hover:-translate-y-1 animate-fadeInSlideUp" style="animation-delay: 0.3s;">
                                    <div class="flex justify-center mb-4"><i data-lucide="message-circle-question" class="h-10 w-10 text-primary-500"></i></div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Medical Q&A</h3>
                                    <p class="text-gray-600">Ask any health-related question and receive evidence-based answers from medical databases.</p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center border border-gray-100 transform hover:-translate-y-1 animate-fadeInSlideUp" style="animation-delay: 0.4s;">
                                    <div class="flex justify-center mb-4"><i data-lucide="image" class="h-10 w-10 text-primary-500"></i></div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Image Analysis</h3>
                                    <p class="text-gray-600">Upload images of rashes, pills, or X-rays (non-diagnostic) for identification and information.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- How It Works Section -->
                    <section id="how-it-works" class="py-16 bg-secondary-50 px-6 rounded-t-3xl shadow-inner">
                        <div class="max-w-6xl mx-auto text-center">
                             <h2 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-4 animate-fadeInSlideUp">How HealthBot AI Works</h2>
                             <p class="text-lg text-gray-600 mb-12 max-w-3xl mx-auto animate-fadeInSlideUp" style="animation-delay: 0.1s;">
                                Simple, secure, and informative healthcare assistance in three easy steps.
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center border border-gray-100 transform hover:-translate-y-1 animate-fadeInSlideUp" style="animation-delay: 0.2s;">
                                    <div class="mb-4 text-5xl font-extrabold text-primary-500">1</div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Describe Your Concern</h3>
                                    <p class="text-gray-600">Tell our AI about your symptoms, health questions, or upload an image in natural language.</p>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center border border-gray-100 transform hover:-translate-y-1 animate-fadeInSlideUp" style="animation-delay: 0.3s;">
                                    <div class="mb-4 text-5xl font-extrabold text-primary-500">2</div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">AI Analysis</h3>
                                    <p class="text-gray-600">Our advanced AI processes your input using medical databases to provide insights.</p>

                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 text-center border border-gray-100 transform hover:-translate-y-1 animate-fadeInSlideUp" style="animation-delay: 0.4s;">
                                    <div class="mb-4 text-5xl font-extrabold text-primary-500">3</div>
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Get Guidance</h3>
                                    <p class="text-gray-600">Receive informational guidance and recommendations to consult healthcare professionals.</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- Safety Section -->
                    <section id="safety" class="py-16 bg-white px-6">
                        <div class="max-w-6xl mx-auto text-center">
                            <h2 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-4 animate-fadeInSlideUp">Your Safety Is Our Priority</h2>
                            <p class="text-lg text-gray-600 mb-12 max-w-3xl mx-auto animate-fadeInSlideUp" style="animation-delay: 0.1s;">
                                HealthBot AI is designed with multiple safety measures and clear limitations.
                            </p>
                            <div class="bg-emergency-50 text-emergency-800 p-6 rounded-xl shadow-md mb-10 text-left border border-emergency-200 transform hover:scale-[1.01] transition-transform duration-300 animate-fadeInSlideUp" style="animation-delay: 0.2s;">
                                <i data-lucide="alert-triangle" class="inline-block mr-3 h-6 w-6 text-emergency-600"></i>
                                <span class="font-semibold text-xl">Emergency Situations</span>
                                <p class="mt-2 text-lg">
                                    If you're experiencing a medical emergency, call emergency services immediately. Do not rely on AI for
                                    emergency medical care.
                                </p>
                            </div>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left mt-12">
                                <div class="bg-gray-50 p-6 rounded-xl shadow-sm border border-gray-100 animate-fadeInSlideUp" style="animation-delay: 0.3s;">
                                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">What We Do</h3>
                                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                                        <li>Provide general health information</li>
                                        <li>Analyze symptoms and suggest possibilities</li>
                                        <li>Offer wellness and prevention tips</li>
                                        <li>Guide you to appropriate care levels</li>
                                    </ul>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-xl shadow-sm border border-gray-100 animate-fadeInSlideUp" style="animation-delay: 0.4s;">
                                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">What We Don't Do</h3>
                                    <ul class="list-disc list-inside text-gray-700 space-y-2">
                                        <li>Diagnose medical conditions</li>
                                        <li>Prescribe medications</li>
                                        <li>Replace professional medical care</li>
                                        <li>Handle medical emergencies</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- CTA Section -->
                    <section class="py-20 bg-gradient-to-r from-primary-600 to-primary-500 text-white text-center rounded-t-3xl px-6 shadow-xl animate-fadeInSlideUp" style="animation-delay: 0.5s;">
                        <div class="max-w-4xl mx-auto">
                            <h2 class="text-3xl md:text-5xl font-extrabold mb-4 leading-tight drop-shadow-md">Ready to Get Started?</h2>
                            <p class="text-lg md:text-xl mb-8 opacity-90 max-w-2xl mx-auto drop-shadow-sm">
                                Get answers to your health questions and guidance you can understand.
                            </p>
                            <button id="start-consultation-footer-btn"
                                class="bg-white text-primary-600 hover:bg-gray-100 font-semibold py-3 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-white">
                                Start Your Free Consultation
                            </button>
                        </div>
                    </section>
                </main>

                <!-- Footer -->
                <footer class="bg-gray-800 text-gray-300 py-12 px-6 rounded-t-xl">
                    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-8">
                        <div class="space-y-4">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="heart-pulse" class="h-6 w-6 text-primary-500"></i>
                                <span class="text-xl font-bold text-white">HealthBot AI</span>
                            </div>
                            <p class="text-sm">Your trusted AI healthcare assistant, providing 24/7 health guidance and support.</p>
                        </div>
                        <div>
                            <h4 class="font-semibold text-white mb-4">Features</h4>
                            <ul class="space-y-2 text-sm">
                                <li><a href="#features" class="hover:text-primary-400 transition-colors">Symptom Analysis</a></li>
                                <li><a href="#features" class="hover:text-primary-400 transition-colors">Medical Q&A</a></li>
                                <li><a href="#features" class="hover:text-primary-400 transition-colors">Image Analysis</a></li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-white mb-4">Safety</h4>
                            <ul class="space-y-2 text-sm">
                                <li><a href="#safety" class="hover:text-primary-400 transition-colors">Privacy Protected</a></li>
                                <li><a href="#safety" class="hover:text-primary-400 transition-colors">Medical Disclaimers</a></li>
                                <li><a href="#safety" class="hover:text-primary-400 transition-colors">Emergency Guidelines</a></li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold text-white mb-4">Support</h4>
                            <ul class="space-y-2 text-sm">
                                <li><a href="#how-it-works" class="hover:text-primary-400 transition-colors">How It Works</a></li>
                                <li><a href="#safety" class="hover:text-primary-400 transition-colors">Safety Guidelines</a></li>
                                <li><a href="#" class="hover:text-primary-400 transition-colors">Terms of Service</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-8 text-center text-sm text-gray-500 border-t border-gray-700 pt-8">
                        &copy; 2025 HealthBot AI. All rights reserved.
                    </div>
                </footer>
            `;
            lucide.createIcons();

            // Attach event listeners for landing page buttons
            document.getElementById('start-chat-nav-btn')?.addEventListener('click', startChat);
            document.getElementById('start-consultation-btn')?.addEventListener('click', startChat);
            document.getElementById('start-consultation-footer-btn')?.addEventListener('click', startChat);
        }

        // --- CHAT LAYOUT FUNCTIONS ---

        /**
         * Renders the main 2-column shell for the chat interface, handling sidebar state.
         */
        function renderChatLayout() {
            // Determine sidebar state classes based on isSidebarCollapsed
            const sidebarWidthClass = isSidebarCollapsed ? 'md:w-0' : 'md:w-1/4';
            const sidebarVisibilityClass = isSidebarCollapsed ? 'md:overflow-hidden md:invisible md:opacity-0' : 'md:visible md:opacity-100';

            appContainer.innerHTML = `
                <div class="flex h-screen w-full bg-secondary-50 overflow-hidden">
                    
                    <!-- Left Sidebar: Chat History (Collapsible) -->
                    <div id="chat-history-sidebar" class="w-full ${sidebarWidthClass} max-w-md h-full bg-white border-r border-gray-200 flex flex-col shadow-lg transition-all duration-300 ease-in-out ${sidebarVisibilityClass} ${currentConversationId ? 'hidden md:flex' : 'flex'}">
                        <!-- Sidebar Header -->
                        <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                            <div class="flex items-center space-x-2">
                                <i data-lucide="heart-pulse" class="h-6 w-6 text-primary-600"></i>
                                <span class="text-xl font-bold text-gray-800">My Chats</span>
                            </div>
                            <button id="back-to-landing-btn" class="text-gray-500 hover:text-primary-600 p-1 rounded-full hover:bg-gray-100 transition-colors" title="Back to Home">
                                <i data-lucide="home" class="h-5 w-5"></i>
                            </button>
                        </div>
                        <!-- New Chat Button -->
                        <div class="p-4 border-b border-gray-100 flex-shrink-0">
                            <button id="new-chat-btn" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:scale-105 flex items-center justify-center space-x-2">
                                <i data-lucide="plus" class="h-5 w-5"></i>
                                <span>New Consultation</span>
                            </button>
                        </div>
                        <!-- Conversation List -->
                        <div id="conversation-list" class="flex-grow overflow-y-auto chat-messages">
                            <!-- List items will be rendered here by renderHistoryList() -->
                        </div>
                    </div>

                    <!-- Right Side: Active Chat Window -->
                    <div id="active-chat-container" class="flex-1 flex flex-col h-full transition-all duration-300 ease-in-out ${currentConversationId ? 'flex' : 'hidden md:flex'}">
                        <!-- Content will be rendered by renderActiveChat() -->
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            // Attach listeners for sidebar buttons
            document.getElementById('new-chat-btn')?.addEventListener('click', startNewConversation);
            document.getElementById('back-to-landing-btn')?.addEventListener('click', handleBackToLanding);

            // Render the dynamic parts
            renderHistoryList();
            renderActiveChat();
        }

        /**
         * Renders the list of past conversations in the left sidebar.
         */
        function renderHistoryList() {
            const listContainer = document.getElementById('conversation-list');
            if (!listContainer) return; // Guard clause
            
            if (allConversations.length === 0) {
                listContainer.innerHTML = `<p class="text-center text-gray-500 p-4 text-sm">No conversations yet. Start a new one!</p>`;
                return;
            }

            // Generate HTML for each conversation item
            listContainer.innerHTML = allConversations.map(conv => {
                const isActive = conv.id === currentConversationId;
                const lastMsg = conv.lastMessage ? sanitizeHTML(conv.lastMessage) : '...';
                const title = sanitizeHTML(conv.title); // Sanitize for display
                const timestamp = conv.timestamp ? new Date(conv.timestamp).toLocaleString() : 'N/A';
                
                return `
                    <div class="group relative w-full text-left border-b border-gray-100 ${isActive ? 'bg-secondary-100' : 'hover:bg-secondary-50'} transition-colors duration-150">
                        <button class="w-full p-4" onclick="handleSelectConversation('${conv.id}')">
                            <h3 class="font-semibold text-gray-800 truncate ${isActive ? 'text-primary-600' : ''}">${title}</h3>
                            <p class="text-sm text-gray-500 truncate">${lastMsg}</p>
                            <span class="text-xs text-gray-400 mt-1 block">${timestamp}</span>
                        </button>
                        
                        <!-- Three-dot menu button -->
                        <button class="conv-menu-btn absolute top-3 right-3 p-1.5 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-800 opacity-0 group-hover:opacity-100 focus:opacity-100 transition-opacity" onclick="handleToggleConvMenu(event, '${conv.id}')">
                            <i data-lucide="more-vertical" class="h-5 w-5 pointer-events-none"></i>
                        </button>

                        <!-- Dropdown Menu (initially hidden) -->
                        <div id="menu-${conv.id}" class="conv-menu-dropdown hidden absolute top-10 right-4 z-20 w-40 bg-white shadow-lg rounded-lg border border-gray-100 overflow-hidden">
                            <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2" onclick="handleShareConversation(event, '${conv.id}')">
                                <i data-lucide="share-2" class="h-4 w-4"></i>
                                <span>Share</span>
                            </button>
                            <button class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center space-x-2" onclick="handleRenameConversation(event, '${conv.id}', '${sanitizeHTML(conv.title)}')"> 
                                <i data-lucide="edit-3" class="h-4 w-4"></i>
                                <span>Rename</span>
                            </button>
                            <button class="w-full text-left px-4 py-2 text-sm text-emergency-600 hover:bg-emergency-50 flex items-center space-x-2" onclick="handleDeleteConversation(event, '${conv.id}')">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons(); // Re-render icons after updating HTML
        }

        /**
         * Renders the active chat window (messages, input area, etc.)
         */
        function renderActiveChat() {
            const container = document.getElementById('active-chat-container');
            if (!container) return; // Guard clause

            // Handle the "empty state" (no chat selected)
            if (!currentConversationId) {
                container.innerHTML = `
                    <div class="flex flex-col h-full items-center justify-center text-center p-8 relative">
                        <!-- Header with sidebar toggle for empty state -->
                        <div class="absolute top-0 left-0 p-4 md:flex items-center space-x-3">
                            <button id="sidebar-toggle" class="text-gray-600 hover:text-primary-600 p-2 rounded-full hover:bg-gray-100 transition-colors" title="Toggle Menu">
                                <i data-lucide="menu" class="h-6 w-6"></i>
                            </button>
                        </div>
                        <i data-lucide="message-square-plus" class="h-24 w-24 text-gray-300 mb-4"></i>
                        <h2 class="text-2xl font-semibold text-gray-700">Welcome to HealthBot AI</h2>
                        <p class="text-gray-500 mt-2">Select a conversation from the left or start a new one.</p>
                    </div>
                `;
                lucide.createIcons();
                // Attach listener for the toggle button in empty state
                document.getElementById('sidebar-toggle')?.addEventListener('click', handleToggleSidebar);
                return;
            }

            // Find the current conversation metadata
            const currentConv = allConversations.find(c => c.id === currentConversationId);
            const chatTitle = currentConv ? sanitizeHTML(currentConv.title) : 'Chat';

            // Render the full chat interface for the active conversation
            container.innerHTML = `
                <!-- Chat Header -->
                <div class="p-4 bg-white border-b border-gray-200 flex items-center space-x-3 flex-shrink-0">
                    <!-- Sidebar Toggle Button (Desktop) -->
                    <button id="sidebar-toggle" class="hidden md:block text-gray-600 hover:text-primary-600 p-2 rounded-full hover:bg-gray-100 transition-colors" title="Toggle Menu">
                        <i data-lucide="menu" class="h-6 w-6"></i>
                    </button>
                    <!-- Back Button (Mobile) -->
                    <button id="back-to-history-btn" class="md:hidden text-gray-600 hover:text-primary-600 p-1">
                        <i data-lucide="chevron-left" class="h-6 w-6"></i>
                    </button>
                    <span class="text-lg font-semibold text-gray-800 truncate">${chatTitle}</span>
                </div>

                <!-- Disclaimer -->
                <div class="bg-warning-50 text-warning-800 p-3 text-sm rounded-lg m-4 shadow-inner border border-warning-200 animate-fadeInSlideUp flex-shrink-0">
                    <i data-lucide="alert-triangle" class="inline-block mr-2 h-4 w-4 text-warning-700"></i>
                    <span class="font-medium">Medical Disclaimer:</span> This AI provides general info, not professional advice. Call 911 for emergencies.
                </div>

                <!-- Chat Messages Area -->
                <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4 chat-messages">
                    <!-- Messages rendered by displayMessages() -->
                </div>

                <!-- Quick Action Buttons (Stable Version - No 'Generate Image') -->
                <div class="flex justify-start overflow-x-auto gap-3 px-4 pb-2 border-t border-gray-100 pt-3 bg-secondary-50 flex-shrink-0">
                    <button class="quick-action-btn flex-shrink-0 bg-white hover:bg-primary-50 text-gray-700 hover:text-primary-700 text-sm py-2 px-4 rounded-full shadow-sm transition-all duration-200 transform hover:scale-105 border border-gray-200" data-message="What are common headache symptoms?">
                        Headache Symptoms
                    </button>
                    <button class="quick-action-btn flex-shrink-0 bg-white hover:bg-primary-50 text-gray-700 hover:text-primary-700 text-sm py-2 px-4 rounded-full shadow-sm transition-all duration-200 transform hover:scale-105 border border-gray-200" data-message="Tell me about fever and illness.">
                        Fever & Illness
                    </button>
                    <button class="quick-action-btn flex-shrink-0 bg-white hover:bg-primary-50 text-gray-700 hover:text-primary-700 text-sm py-2 px-4 rounded-full shadow-sm transition-all duration-200 transform hover:scale-105 border border-gray-200" data-message="Analyze Rash Image">
                        Analyze Rash Image
                    </button>
                    <!-- REMOVED 'Generate Image' button -->
                </div>
                
                <!-- File Preview Area -->
                <div id="file-preview-container" class="px-4 py-2 bg-white border-t border-gray-200 flex-shrink-0" style="display: none;">
                    <div id="file-previews" class="flex flex-wrap gap-2"></div>
                </div>

                <!-- Chat Input Area -->
                <div class="p-4 bg-white border-t border-gray-200 shadow-inner rounded-t-xl flex-shrink-0">
                    <div class="flex items-end space-x-3">
                        <label for="file-upload" class="cursor-pointer">
                            <div class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-3 rounded-full shadow-sm transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-gray-300">
                                <i data-lucide="paperclip" class="h-6 w-6"></i>
                            </div>
                        </label>
                        <input type="file" id="file-upload" class="hidden" multiple accept="image/*">

                        <textarea id="chat-input"
                            class="textarea-auto-resize flex-grow p-3 border border-gray-300 rounded-lg bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent focus:bg-white transition-all duration-200"
                            placeholder="Describe your symptoms or ask a health question..."
                            rows="1"
                            style="min-height: 3rem; max-height: 10rem;"
                        ></textarea>
                        ${SpeechRecognition ? `
                        <button id="mic-btn"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-3 rounded-full shadow-sm transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            <i data-lucide="mic" class="h-6 w-6"></i>
                        </button>
                        ` : ''}
                        <button id="send-btn"
                            class="bg-primary-600 hover:bg-primary-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-primary-300">
                            <i data-lucide="send" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>
            `;

            lucide.createIcons();
            displayMessages(); // Populate the messages for this conversation
            setupChatEventListeners(); // Re-attach listeners for inputs/buttons in active chat
        }

        /**
         * Renders the messages for the currently active conversation.
         */
        function displayMessages() {
            const chatMessagesDiv = document.getElementById('chat-messages');
            if (!chatMessagesDiv) return; // Guard if element not found

            chatMessagesDiv.innerHTML = ''; // Clear previous messages

            // Display placeholder if no messages and not loading
            if (currentConversationMessages.length === 0 && !isLoading) {
                chatMessagesDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-10 animate-fadeInSlideUp">
                        <p class="text-lg">Start the conversation!</p>
                        <p class="text-sm mt-2">Ask a health question or describe your symptoms.</p>
                    </div>
                `;
            }

            // Render each message
            currentConversationMessages.forEach((message, index) => {
                const messageDiv = document.createElement('div');
                const animationClass = message.sender === 'user' ? 'animate-slideInRight' : 'animate-slideInLeft';
                messageDiv.className = `flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'} ${animationClass}`;
                
                let messageBubbleClass = '';
                if (message.sender === 'user') {
                    messageBubbleClass = 'bg-primary-600 text-white rounded-br-none rounded-t-lg rounded-bl-lg';
                } else if (message.isEmergency) {
                    messageBubbleClass = 'bg-emergency-50 text-emergency-800 rounded-bl-none rounded-t-lg rounded-br-lg border border-emergency-300';
                } else {
                    messageBubbleClass = 'bg-white text-gray-800 rounded-bl-none rounded-t-lg rounded-br-lg border border-gray-100 shadow-sm';
                }

                const timestamp = message.timestamp ? new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                
                messageDiv.innerHTML = `
                    <div class="max-w-[80%] md:max-w-[70%] px-4 py-3 rounded-lg shadow-md ${messageBubbleClass}">
                        ${message.isEmergency ? `<strong class="block mb-1 text-emergency-900"><i data-lucide="alert-triangle" class="inline-block h-4 w-4 mr-1"></i> EMERGENCY ALERT!</strong>` : ''}
                        
                        <!-- For user-uploaded images -->
                        ${message.filePreview ? `
                        <div class="mb-2">
                            <img src="${message.filePreview}" alt="Uploaded image" class="max-w-full h-auto rounded-lg shadow max-h-60 cursor-pointer" onclick="window.open('${message.filePreview}')">
                        </div>
                        ` : ''}
                        
                        <!-- REMOVED: Image Generation Display Logic -->
                        
                        <p class="whitespace-pre-wrap">${markdownToHtml(message.text)}</p>
                        
                        <span class="block text-right text-xs mt-1 opacity-75">
                            ${timestamp}
                        </span>
                    </div>
                `;
                chatMessagesDiv.appendChild(messageDiv);
            });

            // Add typing indicator if loading
            if (isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = "flex justify-start animate-slideInLeft";
                loadingDiv.innerHTML = `
                    <div class="max-w-[70%] px-4 py-3 rounded-lg shadow-md bg-white text-gray-800 rounded-bl-none rounded-t-lg rounded-br-lg border border-gray-100">
                        <div class="flex items-center dot-animation">
                            <span class="inline-block w-2 h-2 bg-primary-500 rounded-full mx-0.5"></span>
                            <span class="inline-block w-2 h-2 bg-primary-500 rounded-full mx-0.5"></span>
                            <span class="inline-block w-2 h-2 bg-primary-500 rounded-full mx-0.5"></span>
                            <span class="ml-2 text-gray-600">Typing...</span>
                        </div>
                    </div>
                `;
                chatMessagesDiv.appendChild(loadingDiv);
            }
            
            lucide.createIcons(); // Ensure icons in messages render
            chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // Scroll to bottom
        }

        // --- Event Handlers ---

        function startChat() {
            currentView = 'chat';
            loadAllConversations(); // Load saved conversation list
            
            if (allConversations.length === 0) {
                startNewConversation(false); 
            } else {
                currentConversationId = allConversations[0].id;
                currentConversationMessages = loadConversationMessages(currentConversationId);
            }
            
            renderChatLayout(); 
        }

        function startNewConversation(renderLayout = true) {
            const newId = 'conv-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5); 
            currentConversationId = newId;
            currentConversationMessages = [{
                text: "Hello! I'm HealthBot AI. How can I assist you today? Remember to consult a doctor for medical advice.",
                sender: 'ai',
                timestamp: Date.now(),
                isEmergency: false
            }];
            
            const newConv = {
                id: newId,
                title: 'New Conversation ' + new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit'}),
                lastMessage: 'Hello! I\'m HealthBot AI...',
                timestamp: Date.now()
            };
            
            allConversations.unshift(newConv); 
            
            saveAllConversations();
            saveCurrentConversationMessages();
            
            if (renderLayout) {
                renderChatLayout(); 
            } else {
                renderHistoryList();
                renderActiveChat();
            }
            
            showChatView();
        }

        function handleSelectConversation(convId) {
            if (convId === currentConversationId) {
                showChatView(); 
                return; 
            }

            currentConversationId = convId; 
            currentConversationMessages = loadConversationMessages(convId); 
            
            renderHistoryList();
            renderActiveChat();

            showChatView();
        }

        function handleBackToLanding() {
            currentView = 'landing';
            currentConversationId = null;
            currentConversationMessages = [];
            allConversations = []; 
            renderLandingPage(); 
        }

        function handleBackToHistory() {
            const historySidebar = document.getElementById('chat-history-sidebar');
            const activeChat = document.getElementById('active-chat-container');
            if (historySidebar && activeChat) {
                historySidebar.classList.remove('hidden');
                historySidebar.classList.add('flex');
                activeChat.classList.add('hidden');
                activeChat.classList.remove('flex'); 
            }
        }

        function showChatView() {
            if (window.innerWidth < 768) { 
                 const historySidebar = document.getElementById('chat-history-sidebar');
                 const activeChat = document.getElementById('active-chat-container');
                 if (historySidebar && activeChat) {
                    historySidebar.classList.add('hidden');
                    historySidebar.classList.remove('flex');
                    activeChat.classList.remove('hidden');
                    activeChat.classList.add('flex');
                 }
            }
        }

        // --- Sidebar and Menu Handlers ---

        function handleToggleSidebar() {
            isSidebarCollapsed = !isSidebarCollapsed;
            const sidebar = document.getElementById('chat-history-sidebar');
            
            if (sidebar) {
                if (isSidebarCollapsed) {
                    sidebar.classList.remove('md:w-1/4', 'md:visible', 'md:opacity-100');
                    sidebar.classList.add('md:w-0', 'md:overflow-hidden', 'md:invisible', 'md:opacity-0');
                } else {
                    sidebar.classList.remove('md:w-0', 'md:overflow-hidden', 'md:invisible', 'md:opacity-0');
                    sidebar.classList.add('md:w-1/4', 'md:visible', 'md:opacity-100');
                }
            }
        }

        function handleToggleConvMenu(event, convId) {
            event.stopPropagation(); 
            const menu = document.getElementById(`menu-${convId}`);
            if (menu) {
                const isHidden = menu.classList.toggle('hidden');
                document.querySelectorAll('.conv-menu-dropdown').forEach(m => {
                    if (m.id !== `menu-${convId}`) {
                        m.classList.add('hidden');
                    }
                });
            }
        }
        
        function handleShareConversation(event, convId) {
            event.stopPropagation(); 
            const messagesToShare = loadConversationMessages(convId);
            const convMeta = allConversations.find(c => c.id === convId);
            const title = convMeta ? convMeta.title : 'Chat History';
            
            let chatText = `Conversation: ${title}\n`;
            chatText += `Shared on: ${new Date().toLocaleString()}\n`;
            chatText += "========================================\n\n";

            messagesToShare.forEach(msg => {
                const prefix = msg.sender === 'user' ? '[User]' : '[HealthBot AI]';
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                chatText += `${prefix} (${time}):\n${msg.text}\n\n`; 
                // REMOVED check for generatedImage 
                if (msg.filePreview) chatText += `[User Uploaded Image]\n\n`;
            });

            const textArea = document.createElement('textarea');
            textArea.value = chatText;
            textArea.style.position = 'fixed'; 
            textArea.style.top = '-9999px';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    displayMessageBox('Conversation copied to clipboard!', 'success');
                } else {
                     displayMessageBox('Failed to copy chat (execCommand failed).', 'error');
                }
            } catch (err) {
                console.error('Clipboard copy failed:', err);
                displayMessageBox('Failed to copy chat.', 'error');
            }
            document.body.removeChild(textArea);
            
            const menu = document.getElementById(`menu-${convId}`);
            if (menu) menu.classList.add('hidden');
        }

        function handleRenameConversation(event, convId, currentTitle) {
            event.stopPropagation();
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = currentTitle;
            const rawTitle = tempDiv.textContent || tempDiv.innerText || "";
            
            renderRenameModal(convId, rawTitle);
            
            const menu = document.getElementById(`menu-${convId}`);
            if (menu) menu.classList.add('hidden');
        }

        function handleDeleteConversation(event, convId) {
            event.stopPropagation();
            renderConfirmationModal(
                'Delete Conversation',
                'Are you sure? This action cannot be undone.',
                () => { 
                    deleteConversationFromStorage(convId);
                    
                    if (currentConversationId === convId) {
                        currentConversationId = null;
                        currentConversationMessages = [];
                        if (allConversations.length > 0) {
                             handleSelectConversation(allConversations[0].id);
                        } else {
                             renderActiveChat();
                        }
                    }
                    renderHistoryList();
                }
            );
            const menu = document.getElementById(`menu-${convId}`);
            if (menu) menu.classList.add('hidden');
        }

        // --------------------------------------------------

        async function handleSendMessage(text) {
            const messageText = text ? text.trim() : ""; 
            const hasFiles = uploadedFiles.length > 0;

            if ((!messageText && !hasFiles) || isLoading || !currentConversationId) {
                if (!currentConversationId) displayMessageBox('Please start or select a conversation first.', 'info');
                else if (!messageText && !hasFiles) displayMessageBox('Please type a message or upload a file.', 'info');
                return;
            }

            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.value = '';
                adjustTextareaHeight();
            }

            const userMessage = {
                text: messageText,
                sender: 'user',
                timestamp: Date.now()
            };
            
            if (hasFiles) {
                userMessage.files = uploadedFiles; 
                userMessage.filePreview = uploadedFiles[0].preview;
                userMessage.fileType = uploadedFiles[0].type;
            }

            currentConversationMessages.push(userMessage);
            displayMessages(); 
            isLoading = true;
            displayMessages(); // Show typing indicator

            const filesToSend = [...uploadedFiles];
            uploadedFiles = []; 
            const previewContainer = document.getElementById('file-preview-container');
            const previews = document.getElementById('file-previews');
            if (previewContainer && previews) {
                 previewContainer.style.display = 'none';
                 previews.innerHTML = '';
            }

            const activeConv = allConversations.find(c => c.id === currentConversationId);
            if (activeConv) {
                if (activeConv.title.startsWith('New Conversation') && messageText) {
                    activeConv.title = messageText.substring(0, 30) + (messageText.length > 30 ? '...' : '');
                }
                activeConv.lastMessage = messageText 
                    ? (messageText.substring(0, 40) + (messageText.length > 40 ? '...' : '')) 
                    : (filesToSend.length > 0 ? 'Image sent' : '...');
                activeConv.timestamp = Date.now();
                saveAllConversations();
                renderHistoryList();
            }

            const emergencyKeywords = ['emergency', '108', 'help me', 'dying', 'chest pain', 'difficulty breathing', 'severe bleeding', 'unconscious', 'suicide', 'kill myself'];
            if (emergencyKeywords.some(keyword => messageText.toLowerCase().includes(keyword))) {
                const emergencyResponse = {
                    text: " **Emergency Detected! If this is a medical emergency, please call 108 or your local emergency number immediately.** This AI cannot provide emergency assistance.",
                    sender: 'ai',
                    timestamp: Date.now(),
                    isEmergency: true
                };
                currentConversationMessages.push(emergencyResponse);
                saveCurrentConversationMessages();
                isLoading = false;
                displayMessages();
                return;
            }

            // --- Send to Backend ---
            try {
                const backendChatHistory = currentConversationMessages.slice(0, -1).map(msg => ({
                    role: msg.sender === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.text || "" }] 
                }));
                
                const payload = {
                    userId: userId,
                    conversationId: currentConversationId,
                    message: messageText,
                    files: filesToSend,
                    chatHistory: backendChatHistory
                };
                
                const response = await exponentialBackoffFetch(`${BACKEND_API_URL}chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                // --- Stable Version: Handle simple text response ---
                let aiResponseText;
                // REMOVED: let aiGeneratedImage = null;

                if (result.aiResponse || result.aiResponse === "") { 
                    aiResponseText = result.aiResponse;
                } else if (result.error) {
                     aiResponseText = "An error occurred on the backend: " + result.error;
                     console.error("Backend Error:", result.error);
                } else { 
                    aiResponseText = "I'm sorry, I couldn't get a valid response. Please try again.";
                    console.error("Invalid backend response:", result);
                }
                // REMOVED: Check for result.generatedImage
                // ---------------------------------------------------------

                // Add AI response to messages
                currentConversationMessages.push({
                    text: aiResponseText || "", 
                    sender: 'ai',
                    timestamp: Date.now(),
                    isEmergency: false,
                    // REMOVED: generatedImage: aiGeneratedImage 
                });

                // Update metadata again with AI's response preview
                if (activeConv) {
                    let lastMsgPreview = (aiResponseText || "").substring(0, 40) + ((aiResponseText || "").length > 40 ? '...' : '');
                    // REMOVED: Check for aiGeneratedImage in preview
                    activeConv.lastMessage = lastMsgPreview;
                    activeConv.timestamp = Date.now();
                    saveAllConversations();
                    renderHistoryList();
                }

            } catch (error) {
                console.error("Error communicating with backend:", error);
                currentConversationMessages.push({
                    text: `Sorry, I couldn't connect to the AI service. Please check if the backend is running and try again. (Error: ${error.message})`,
                    sender: 'ai',
                    timestamp: Date.now(),
                    isEmergency: false 
                });
            } finally {
                isLoading = false;
                saveCurrentConversationMessages();
                displayMessages();
            }
        }

        function handleFileUpload(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            uploadedFiles = [];
            const previewContainer = document.getElementById('file-previews');
            const containerDiv = document.getElementById('file-preview-container');

            if (!previewContainer || !containerDiv) return;

            previewContainer.innerHTML = '';
            containerDiv.style.display = 'block';
            
            const file = files[0]; 

            if (!file.type.startsWith("image/")) {
                displayMessageBox("Only image files (JPEG, PNG, GIF, etc.) are allowed.", "error");
                containerDiv.style.display = 'none';
                event.target.value = null;
                return;
            }

            const maxSizeMB = 5;
            if (file.size > maxSizeMB * 1024 * 1024) {
                 displayMessageBox(`File size exceeds the ${maxSizeMB}MB limit.`, "error");
                 containerDiv.style.display = 'none';
                 event.target.value = null;
                 return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = e.target.result;
                uploadedFiles = [{
                    name: file.name, 
                    type: file.type,
                    size: file.size, 
                    preview: preview
                }];

                const filePreviewDiv = document.createElement('div');
                filePreviewDiv.className = 'relative flex items-center p-2 rounded-lg bg-gray-100 text-gray-800 max-w-[200px] overflow-hidden';
                filePreviewDiv.innerHTML = `
                    <img src="${preview}" alt="Preview" class="w-12 h-12 object-cover rounded-md mr-2"> 
                    <span class="truncate text-sm">${sanitizeHTML(file.name)}</span>`;
                
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = `<i data-lucide="x" class="h-4 w-4"></i>`;
                removeBtn.className = 'absolute top-1 right-1 p-0.5 rounded-full bg-red-500 text-white hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300';
                removeBtn.onclick = () => {
                    uploadedFiles = [];
                    filePreviewDiv.remove();
                    containerDiv.style.display = 'none';
                    event.target.value = null;
                };
                
                filePreviewDiv.appendChild(removeBtn);
                previewContainer.appendChild(filePreviewDiv);
                lucide.createIcons();
            };
             reader.onerror = (e) => {
                console.error("FileReader error:", e);
                displayMessageBox("Error reading file.", "error");
                containerDiv.style.display = 'none';
                 event.target.value = null;
            };
            reader.readAsDataURL(file);
        }

        function toggleVoiceInput() {
            if (!recognition) {
                displayMessageBox("Voice input is not supported by your browser.", 'error');
                return;
            }
            if (isRecording) { recognition.stop(); }
            else { 
                try {
                    recognition.start(); 
                } catch (e) {
                    console.error("Speech recognition start error:", e);
                    displayMessageBox(`Could not start voice input: ${e.message}`, 'error');
                    isRecording = false;
                    updateMicButtonState();
                }
            }
        }

        function updateMicButtonState() {
            const micBtn = document.getElementById('mic-btn');
            if (micBtn) {
                const micIcon = micBtn.querySelector('i[data-lucide]');
                if (isRecording) {
                    micBtn.classList.add('bg-emergency-600', 'text-white', 'mic-recording-pulse');
                    micBtn.classList.remove('bg-gray-100', 'text-gray-700');
                    if (micIcon) micIcon.setAttribute('data-lucide', 'mic-off');
                } else {
                    micBtn.classList.remove('bg-emergency-600', 'text-white', 'mic-recording-pulse');
                    micBtn.classList.add('bg-gray-100', 'text-gray-700');
                    if (micIcon) micIcon.setAttribute('data-lucide', 'mic');
                }
                lucide.createIcons(); 
            }
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('chat-input');
            if (textarea) {
                textarea.style.height = 'auto';
                const maxHeight = parseInt(textarea.style.maxHeight || '160', 10); 
                textarea.style.height = Math.min(textarea.scrollHeight, maxHeight) + 'px';
            }
        }

        /**
         * Attaches event listeners for the active chat input area.
         */
        function setupChatEventListeners() {
            const sendBtn = document.getElementById('send-btn');
            const fileUpload = document.getElementById('file-upload');
            const chatInput = document.getElementById('chat-input');
            const micBtn = document.getElementById('mic-btn');

            if (sendBtn) {
                sendBtn.replaceWith(sendBtn.cloneNode(true));
                document.getElementById('send-btn').addEventListener('click', () => {
                    const currentChatInput = document.getElementById('chat-input');
                    handleSendMessage(currentChatInput ? currentChatInput.value : "");
                });
            }

            if (fileUpload) {
                 fileUpload.replaceWith(fileUpload.cloneNode(true));
                 document.getElementById('file-upload').addEventListener('change', handleFileUpload);
            }
            
            if (chatInput) {
                chatInput.replaceWith(chatInput.cloneNode(true));
                const newChatInput = document.getElementById('chat-input');
                
                newChatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage(newChatInput.value);
                    }
                });
                newChatInput.addEventListener('input', adjustTextareaHeight);
            }

            if (micBtn) {
                 micBtn.replaceWith(micBtn.cloneNode(true));
                 document.getElementById('mic-btn').addEventListener('click', toggleVoiceInput);
            }

            const backToHistoryBtn = document.getElementById('back-to-history-btn');
            const sidebarToggleBtn = document.getElementById('sidebar-toggle');

            if (backToHistoryBtn) {
                 backToHistoryBtn.replaceWith(backToHistoryBtn.cloneNode(true));
                 document.getElementById('back-to-history-btn').addEventListener('click', handleBackToHistory);
            }
            if (sidebarToggleBtn) {
                 sidebarToggleBtn.replaceWith(sidebarToggleBtn.cloneNode(true));
                 document.getElementById('sidebar-toggle').addEventListener('click', handleToggleSidebar);
            }

            // --- Quick Action Buttons (Stable Version - Removed 'Generate Image') ---
            document.querySelectorAll('.quick-action-btn').forEach(button => {
                 const newButton = button.cloneNode(true);
                 button.parentNode.replaceChild(newButton, button);

                 newButton.addEventListener('click', (e) => {
                    const message = e.target.dataset.message;
                    const currentChatInput = document.getElementById('chat-input');
                    const currentFileUpload = document.getElementById('file-upload');
                    
                    if (message === "Analyze Rash Image") {
                        if (currentChatInput) currentChatInput.value = "Please analyze this image.";
                        if (currentFileUpload) currentFileUpload.click();
                    } 
                    // REMOVED: else if (message === "Generate Image")
                    else { // For all other buttons
                        if (currentChatInput) currentChatInput.value = message;
                        handleSendMessage(message);
                    }
                    if (currentChatInput) adjustTextareaHeight();
                });
            });
        }


        // --- Initial Application Load ---
        renderLandingPage(); // Start with the landing page

    </script>
</body>
</html>



