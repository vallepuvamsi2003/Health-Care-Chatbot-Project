<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthBot AI - Premium Healthcare Assistant</title>
    
    <link rel="icon" type="image/png" href="medical-robot (1).png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 20px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .textarea-auto-resize { overflow: hidden; resize: none; }

        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeInSlideUp { animation: fadeInSlideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes popIn {
            from { opacity: 0; transform: translateY(-10px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-popIn { animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .medical-pattern {
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
                    colors: {
                        'primary': { 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        'emergency': { 50: '#fef2f2', 600: '#dc2626' }
                    },
                    boxShadow: { 'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)' }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen text-slate-800 antialiased">
    <div id="message-box-container" class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] flex flex-col items-center space-y-3 pointer-events-none"></div>
    <div id="modal-container"></div>
    <div id="app" class="flex flex-col min-h-screen bg-slate-50"></div>

    <script>
        // --- APP STATE ---
        const appContainer = document.getElementById('app');
        let currentView = 'landing';
        let userId = 'user-' + Math.random().toString(36).substr(2, 9);
        let allConversations = [];
        let currentConversationId = null;
        let currentConversationMessages = [];
        let isLoading = false;
        let isRecording = false;
        let uploadedFiles = [];
        let isSidebarCollapsed = false;

        // FIXED: Using relative path for Render. This fixes the "Failed to Fetch" error.
        const BACKEND_API_URL = '/';

        // Initialize Speech Recognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                const chatInput = document.getElementById('chat-input');
                if (chatInput) { chatInput.value = speechResult; adjustTextareaHeight(); }
            };
        }

        // --- CORE FUNCTIONS ---

        function sanitizeHTML(str) {
            if (!str) return "";
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        function markdownToHtml(markdownText) {
            let html = sanitizeHTML(markdownText);
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        async function exponentialBackoffFetch(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return exponentialBackoffFetch(url, options, retries - 1, delay * 2);
                } else { throw error; }
            }
        }

        function displayMessageBox(message, type = 'info') {
            const container = document.getElementById('message-box-container');
            const messageBox = document.createElement('div');
            messageBox.className = `px-4 py-3 rounded-xl shadow-soft text-sm font-medium pointer-events-auto flex items-center space-x-3 animate-popIn backdrop-blur-md border border-opacity-20 bg-slate-800 text-white`;
            if (type === 'error') messageBox.classList.add('bg-red-600');
            if (type === 'success') messageBox.classList.add('bg-emerald-600');
            
            messageBox.innerHTML = `<span>${sanitizeHTML(message)}</span>`;
            container.appendChild(messageBox);
            setTimeout(() => { messageBox.remove(); }, 3000);
        }

        // --- STORAGE ---
        function saveAllConversations() {
            localStorage.setItem('healthBotConversations', JSON.stringify(allConversations));
        }
        function saveCurrentConversationMessages() {
            if (currentConversationId) {
                localStorage.setItem(`healthBot_${currentConversationId}`, JSON.stringify(currentConversationMessages));
            }
        }
        function loadAllConversations() {
            allConversations = JSON.parse(localStorage.getItem('healthBotConversations')) || [];
        }
        function loadConversationMessages(id) {
            return JSON.parse(localStorage.getItem(`healthBot_${id}`)) || [];
        }

        // --- RENDERING ---

        function renderLandingPage() {
            appContainer.innerHTML = `
                <header class="fixed top-0 left-0 right-0 z-20 glass-effect py-4 px-6 md:px-12 flex items-center justify-between animate-fadeInSlideUp">
                    <div class="flex items-center space-x-2.5">
                        <div class="bg-primary-600 p-2 rounded-lg shadow-lg">
                            <i data-lucide="activity" class="h-6 w-6 text-white"></i>
                        </div>
                        <span class="text-2xl font-bold text-slate-900">HealthBot AI</span>
                    </div>
                    <nav class="hidden md:flex items-center space-x-8">
                        <button onclick="startChat()" class="bg-slate-900 text-white font-semibold py-2.5 px-6 rounded-full">Start Consultation</button>
                    </nav>
                </header>
                <main class="flex-grow pt-48 text-center px-6">
                    <h1 class="text-5xl md:text-7xl font-extrabold mb-6 text-slate-900">Your Health, <span class="text-primary-600">Intelligently</span> Simplified.</h1>
                    <p class="text-lg text-slate-500 mb-10 max-w-2xl mx-auto">Experience 24/7 personalized health guidance powered by advanced AI.</p>
                    <button onclick="startChat()" class="bg-primary-600 text-white font-bold py-4 px-10 rounded-full shadow-xl">Start Free Consultation</button>
                </main>
            `;
            lucide.createIcons();
        }

        function renderChatLayout() {
            const sidebarWidth = isSidebarCollapsed ? 'md:w-0' : 'md:w-80';
            appContainer.innerHTML = `
                <div class="flex h-screen w-full bg-slate-50 overflow-hidden">
                    <div id="chat-history-sidebar" class="${sidebarWidth} h-full bg-white border-r flex flex-col transition-all duration-300">
                        <div class="p-5 border-b flex items-center justify-between">
                            <span class="font-bold text-lg">History</span>
                            <button onclick="handleBackToLanding()"><i data-lucide="log-out" class="h-5 w-5"></i></button>
                        </div>
                        <div class="p-4"><button onclick="startNewConversation()" class="w-full bg-slate-900 text-white py-3 rounded-xl">+ New Chat</button></div>
                        <div id="conversation-list" class="flex-grow overflow-y-auto px-3"></div>
                    </div>
                    <div id="active-chat-container" class="flex-1 flex flex-col h-full relative">
                        <div class="absolute inset-0 medical-pattern opacity-40 z-0"></div>
                        <div id="chat-header" class="p-4 bg-white/80 border-b flex items-center justify-between z-20">
                            <div class="font-bold">Chat</div>
                        </div>
                        <div id="chat-messages" class="flex-grow overflow-y-auto p-4 md:p-6 space-y-6 z-10"></div>
                        <div class="p-4 md:p-6 z-20">
                            <div class="max-w-4xl mx-auto bg-white p-2 rounded-3xl shadow-xl border flex items-end gap-2">
                                <label for="file-upload" class="cursor-pointer p-2.5"><i data-lucide="paperclip" class="h-5 w-5"></i></label>
                                <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="handleFileUpload(event)">
                                <textarea id="chat-input" class="flex-grow py-3 px-2 border-none focus:ring-0" placeholder="Describe symptoms..." rows="1"></textarea>
                                <button id="send-btn" onclick="handleSendMessage()" class="bg-slate-900 text-white p-2.5 rounded-full"><i data-lucide="send" class="h-5 w-5"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            renderHistoryList();
            displayMessages();
            lucide.createIcons();
        }

        function renderHistoryList() {
            const container = document.getElementById('conversation-list');
            if (!container) return;
            container.innerHTML = allConversations.map(conv => `
                <button onclick="handleSelectConversation('${conv.id}')" class="w-full text-left p-3 rounded-xl mb-1 hover:bg-slate-100 ${conv.id === currentConversationId ? 'bg-blue-50' : ''}">
                    <div class="font-semibold text-sm truncate">${sanitizeHTML(conv.title)}</div>
                </button>
            `).join('');
        }

        // --- LOGIC ---

        function startChat() {
            loadAllConversations();
            if (allConversations.length === 0) startNewConversation();
            else {
                currentConversationId = allConversations[0].id;
                currentConversationMessages = loadConversationMessages(currentConversationId);
                renderChatLayout();
            }
        }

        function startNewConversation() {
            const newId = 'conv-' + Date.now();
            currentConversationId = newId;
            currentConversationMessages = [{ text: "Hello! I'm **HealthBot AI**. How are you feeling today?", sender: 'ai', timestamp: Date.now() }];
            allConversations.unshift({ id: newId, title: 'New Chat', timestamp: Date.now() });
            saveAllConversations();
            saveCurrentConversationMessages();
            renderChatLayout();
        }

        function handleSelectConversation(id) {
            currentConversationId = id;
            currentConversationMessages = loadConversationMessages(id);
            renderChatLayout();
        }

        function handleBackToLanding() { renderLandingPage(); }

        async function handleSendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text && uploadedFiles.length === 0) return;

            const userMsg = { text: text, sender: 'user', timestamp: Date.now() };
            if (uploadedFiles.length > 0) {
                userMsg.filePreview = uploadedFiles[0].preview;
            }

            currentConversationMessages.push(userMsg);
            input.value = '';
            isLoading = true;
            displayMessages();

            try {
                const response = await fetch(`${BACKEND_API_URL}chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, files: uploadedFiles })
                });
                const data = await response.json();
                currentConversationMessages.push({ text: data.aiResponse, sender: 'ai', timestamp: Date.now() });
            } catch (e) {
                currentConversationMessages.push({ text: "Connection error. Please check your backend.", sender: 'ai' });
            } finally {
                isLoading = false;
                uploadedFiles = [];
                saveCurrentConversationMessages();
                displayMessages();
            }
        }

        function displayMessages() {
            const div = document.getElementById('chat-messages');
            if (!div) return;
            div.innerHTML = currentConversationMessages.map(msg => {
                const isUser = msg.sender === 'user';
                return `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'} animate-fadeInSlideUp">
                        <div class="max-w-[80%] p-4 rounded-2xl ${isUser ? 'bg-slate-900 text-white' : 'bg-white border text-slate-800'}">
                            ${msg.filePreview ? `<img src="${msg.filePreview}" class="mb-2 rounded-lg max-h-48">` : ''}
                            <div>${markdownToHtml(msg.text)}</div>
                        </div>
                    </div>
                `;
            }).join('');
            if (isLoading) div.innerHTML += `<div class="text-slate-400 text-sm">Bot is thinking...</div>`;
            div.scrollTop = div.scrollHeight;
            lucide.createIcons();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = (e) => {
                uploadedFiles = [{ name: file.name, preview: e.target.result }];
                displayMessageBox("Image uploaded!", "success");
            };
            reader.readAsDataURL(file);
        }

        function handleBackToLanding() { renderLandingPage(); }
        function adjustTextareaHeight() { /* Placeholder */ }

        // Start the app
        document.addEventListener('DOMContentLoaded', () => {
            renderLandingPage();
        });
    </script>
</body>
</html>
